<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jotform Filter Test</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #252526;
      border-left: 4px solid #007acc;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      font-family: inherit;
    }
    button:hover {
      background: #1177bb;
    }
    .result {
      margin-top: 10px;
      padding: 10px;
      background: #1e1e1e;
      border: 1px solid #3c3c3c;
      white-space: pre-wrap;
      font-size: 12px;
    }
    .success { border-left: 4px solid #4ec9b0; }
    .error { border-left: 4px solid #f48771; }
    .warning { border-left: 4px solid #ce9178; }
    input {
      padding: 8px;
      background: #3c3c3c;
      border: 1px solid #555;
      color: #d4d4d4;
      font-family: inherit;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>ðŸ”¬ Jotform API Filter Test</h1>
  <p>Test if Jotform API filters are working correctly</p>

  <div class="test-section">
    <h2>Configuration</h2>
    <div>
      <input type="text" id="apiKey" placeholder="API Key" value="f45162cb1d42e5e725ef38c9ccc06915" style="width: 400px;">
      <input type="text" id="formId" placeholder="Form ID" value="252152307582049" style="width: 200px;">
      <input type="text" id="studentId" placeholder="Student ID (numeric)" value="10261" style="width: 150px;">
    </div>
  </div>

  <div class="test-section">
    <h2>Test 1: Filter by QID ({"20:eq":"10261"})</h2>
    <button onclick="testQidFilter()">Run Test</button>
    <div id="result-qid" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Filter by Field Name ({"student-id:eq":"10261"})</h2>
    <button onclick="testFieldNameFilter()">Run Test</button>
    <div id="result-field" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: No Filter (Get All Submissions)</h2>
    <button onclick="testNoFilter()">Run Test</button>
    <div id="result-no-filter" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Client-Side Filtering Comparison</h2>
    <button onclick="testClientSideFiltering()">Run Test</button>
    <div id="result-client" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 5: SessionKey Filter (QID 3) - Control Test</h2>
    <p style="font-size: 12px; color: #ce9178;">This proves the filter mechanism works for sessionkey (QID 3)</p>
    <input type="text" id="sessionKey" placeholder="SessionKey (e.g., 10261_20251014_11_38)" value="10261_20251014_11_38" style="width: 400px;">
    <button onclick="testSessionKeyFilter()">Run Test</button>
    <div id="result-sessionkey" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 6: Contains Operator ({"20:contains":"10261"})</h2>
    <p style="font-size: 12px; color: #ce9178;">Jotform support suggests trying :contains instead of :eq for partial matches</p>
    <button onclick="testContainsFilter()">Run Test</button>
    <div id="result-contains" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 7: Matches Operator on SessionKey ({"q3:matches":"10261"})</h2>
    <p style="font-size: 12px; color: #ce9178;">Jotform support recommended - matches student ID pattern in sessionkey field</p>
    <button onclick="testMatchesFilter()">Run Test</button>
    <div id="result-matches" class="result"></div>
  </div>

  <script>
    async function testQidFilter() {
      const resultDiv = document.getElementById('result-qid');
      resultDiv.textContent = 'Testing...';
      resultDiv.className = 'result';

      try {
        const apiKey = document.getElementById('apiKey').value;
        const formId = document.getElementById('formId').value;
        const studentId = document.getElementById('studentId').value;

        const filter = {"20:eq": studentId};
        const filterEncoded = encodeURIComponent(JSON.stringify(filter));
        
        const url = `https://api.jotform.com/form/${formId}/submissions?` +
                    `apiKey=${apiKey}` +
                    `&filter=${filterEncoded}` +
                    `&limit=1000` +
                    `&orderby=created_at` +
                    `&direction=ASC`;

        console.log('QID Filter URL:', url);

        const response = await fetch(url);
        const result = await response.json();

        const output = [];
        output.push(`âœ… Status: ${response.status} ${response.statusText}`);
        output.push(`ðŸ“Š Response Code: ${result.responseCode}`);
        output.push(`ðŸ“ Message: ${result.message}`);
        output.push(`ðŸ“¦ Total Submissions: ${result.content?.length || 0}`);
        output.push('');
        output.push('ðŸ” Filter Used:');
        output.push(`   Raw: ${JSON.stringify(filter)}`);
        output.push(`   Encoded: ${filterEncoded}`);
        output.push('');
        output.push('ðŸ“‹ COMPLETE URL (copy to test in browser):');
        output.push(`   ${url}`);
        output.push('');

        if (result.content && result.content.length > 0) {
          output.push('ðŸ“‹ First 10 Student IDs:');
          result.content.slice(0, 10).forEach((sub, idx) => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || 'MISSING';
            output.push(`   [${idx}] ${id} ${id === studentId ? 'âœ… MATCH' : 'âŒ WRONG'}`);
          });

          const matches = result.content.filter(sub => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || '';
            return id.trim() === studentId;
          });
          output.push('');
          output.push(`âœ¨ Actual Matches: ${matches.length} / ${result.content.length}`);
        }

        resultDiv.textContent = output.join('\n');
        resultDiv.className = result.content?.length === 0 || result.content?.length > 100 ? 'result error' : 'result success';
      } catch (error) {
        resultDiv.textContent = `âŒ Error: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    async function testFieldNameFilter() {
      const resultDiv = document.getElementById('result-field');
      resultDiv.textContent = 'Testing...';
      resultDiv.className = 'result';

      try {
        const apiKey = document.getElementById('apiKey').value;
        const formId = document.getElementById('formId').value;
        const studentId = document.getElementById('studentId').value;

        const filter = {"student-id:eq": studentId};
        const filterEncoded = encodeURIComponent(JSON.stringify(filter));
        
        const url = `https://api.jotform.com/form/${formId}/submissions?` +
                    `apiKey=${apiKey}` +
                    `&filter=${filterEncoded}` +
                    `&limit=1000` +
                    `&orderby=created_at` +
                    `&direction=ASC`;

        console.log('Field Name Filter URL:', url);

        const response = await fetch(url);
        const result = await response.json();

        const output = [];
        output.push(`âœ… Status: ${response.status} ${response.statusText}`);
        output.push(`ðŸ“Š Response Code: ${result.responseCode}`);
        output.push(`ðŸ“ Message: ${result.message}`);
        output.push(`ðŸ“¦ Total Submissions: ${result.content?.length || 0}`);
        output.push('');
        output.push('ðŸ” Filter Used:');
        output.push(`   Raw: ${JSON.stringify(filter)}`);
        output.push(`   Encoded: ${filterEncoded}`);
        output.push('');
        output.push('ðŸ“‹ COMPLETE URL (copy to test in browser):');
        output.push(`   ${url}`);
        output.push('');

        if (result.content && result.content.length > 0) {
          output.push('ðŸ“‹ First 10 Student IDs:');
          result.content.slice(0, 10).forEach((sub, idx) => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || 'MISSING';
            output.push(`   [${idx}] ${id} ${id === studentId ? 'âœ… MATCH' : 'âŒ WRONG'}`);
          });

          const matches = result.content.filter(sub => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || '';
            return id.trim() === studentId;
          });
          output.push('');
          output.push(`âœ¨ Actual Matches: ${matches.length} / ${result.content.length}`);
        }

        resultDiv.textContent = output.join('\n');
        resultDiv.className = result.content?.length === 0 || result.content?.length > 100 ? 'result warning' : 'result success';
      } catch (error) {
        resultDiv.textContent = `âŒ Error: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    async function testNoFilter() {
      const resultDiv = document.getElementById('result-no-filter');
      resultDiv.textContent = 'Testing...';
      resultDiv.className = 'result';

      try {
        const apiKey = document.getElementById('apiKey').value;
        const formId = document.getElementById('formId').value;
        
        const url = `https://api.jotform.com/form/${formId}/submissions?` +
                    `limit=1000` +
                    `&orderby=created_at` +
                    `&direction=ASC` +
                    `&apiKey=${apiKey}`;

        console.log('No Filter URL:', url);

        const response = await fetch(url);
        const result = await response.json();

        const output = [];
        output.push(`âœ… Status: ${response.status} ${response.statusText}`);
        output.push(`ðŸ“Š Response Code: ${result.responseCode}`);
        output.push(`ðŸ“¦ Total Submissions: ${result.content?.length || 0}`);
        output.push('');
        output.push('ðŸ“‹ Unique Student IDs (first 20):');

        if (result.content && result.content.length > 0) {
          const uniqueIds = new Set();
          result.content.forEach(sub => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || 'MISSING';
            uniqueIds.add(id);
          });
          
          Array.from(uniqueIds).slice(0, 20).forEach(id => {
            output.push(`   â€¢ ${id}`);
          });

          output.push('');
          output.push(`ðŸ“Š Total Unique Students: ${uniqueIds.size}`);
        }

        resultDiv.textContent = output.join('\n');
        resultDiv.className = 'result';
      } catch (error) {
        resultDiv.textContent = `âŒ Error: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    async function testClientSideFiltering() {
      const resultDiv = document.getElementById('result-client');
      resultDiv.textContent = 'Testing...';
      resultDiv.className = 'result';

      try {
        const apiKey = document.getElementById('apiKey').value;
        const formId = document.getElementById('formId').value;
        const studentId = document.getElementById('studentId').value;

        // Test both filters
        const filters = [
          {"20:eq": studentId},
          {"student-id:eq": studentId}
        ];

        const results = [];

        for (const [idx, filter] of filters.entries()) {
          const filterEncoded = encodeURIComponent(JSON.stringify(filter));
          const url = `https://api.jotform.com/form/${formId}/submissions?filter=${filterEncoded}&limit=1000&orderby=created_at&direction=ASC&apiKey=${apiKey}`;
          
          const response = await fetch(url);
          const result = await response.json();

          const serverReturned = result.content?.length || 0;
          const clientFiltered = result.content?.filter(sub => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || '';
            return id.trim() === studentId;
          }).length || 0;

          results.push({
            filter: JSON.stringify(filter),
            serverReturned,
            clientFiltered
          });
        }

        const output = [];
        output.push('ðŸ”¬ Comparison: Server Filter vs Client Filter');
        output.push('');
        output.push('Filter Type 1: QID-based {"20:eq":"10261"}');
        output.push(`   Server returned: ${results[0].serverReturned} submissions`);
        output.push(`   Client filtered: ${results[0].clientFiltered} actual matches`);
        output.push(`   âŒ Filter working: ${results[0].serverReturned === results[0].clientFiltered ? 'YES âœ…' : 'NO âŒ'}`);
        output.push('');
        output.push('Filter Type 2: Field name {"student-id:eq":"10261"}');
        output.push(`   Server returned: ${results[1].serverReturned} submissions`);
        output.push(`   Client filtered: ${results[1].clientFiltered} actual matches`);
        output.push(`   âŒ Filter working: ${results[1].serverReturned === results[1].clientFiltered ? 'YES âœ…' : 'NO âŒ'}`);
        output.push('');
        output.push('ðŸ“Š CONCLUSION:');
        if (results[0].serverReturned > results[0].clientFiltered) {
          output.push('   âš ï¸ SERVER FILTER IS BROKEN - returning too many results!');
          output.push('   âœ… Client-side filtering required as fallback');
        } else {
          output.push('   âœ… Server filter is working correctly!');
        }

        resultDiv.textContent = output.join('\n');
        resultDiv.className = 'result warning';
      } catch (error) {
        resultDiv.textContent = `âŒ Error: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    async function testSessionKeyFilter() {
      const resultDiv = document.getElementById('result-sessionkey');
      resultDiv.textContent = 'Testing...';
      resultDiv.className = 'result';

      try {
        const apiKey = document.getElementById('apiKey').value;
        const formId = document.getElementById('formId').value;
        const sessionKey = document.getElementById('sessionKey').value;

        // Test sessionkey filter using QID 3 (this should work like in processor_agent.ps1)
        const filter = {"3:eq": sessionKey};
        const filterEncoded = encodeURIComponent(JSON.stringify(filter));
        
        const url = `https://api.jotform.com/form/${formId}/submissions?` +
                    `apiKey=${apiKey}` +
                    `&filter=${filterEncoded}` +
                    `&limit=1000` +
                    `&orderby=created_at` +
                    `&direction=ASC`;

        console.log('SessionKey Filter URL:', url);

        const response = await fetch(url);
        const result = await response.json();

        const output = [];
        output.push(`âœ… Status: ${response.status} ${response.statusText}`);
        output.push(`ðŸ“Š Response Code: ${result.responseCode}`);
        output.push(`ðŸ“ Message: ${result.message}`);
        output.push(`ðŸ“¦ Total Submissions: ${result.content?.length || 0}`);
        output.push('');
        output.push('ðŸ” Filter Used (like processor_agent.ps1):');
        output.push(`   Raw: ${JSON.stringify(filter)}`);
        output.push(`   Encoded: ${filterEncoded}`);
        output.push('');
        output.push('ðŸ“‹ COMPLETE URL (copy to test in browser):');
        output.push(`   ${url}`);
        output.push('');

        if (result.content && result.content.length > 0) {
          output.push('ðŸ“‹ First 5 SessionKeys:');
          result.content.slice(0, 5).forEach((sub, idx) => {
            const key = sub.answers?.['3']?.answer || sub.answers?.['3']?.text || 'MISSING';
            output.push(`   [${idx}] ${key} ${key === sessionKey ? 'âœ… EXACT MATCH' : 'âŒ'}`);
          });

          const exactMatches = result.content.filter(sub => {
            const key = sub.answers?.['3']?.answer || sub.answers?.['3']?.text || '';
            return key.trim() === sessionKey;
          });

          output.push('');
          output.push(`âœ¨ Exact Matches: ${exactMatches.length} / ${result.content.length}`);
          output.push('');
          
          if (exactMatches.length === result.content.length) {
            output.push('âœ… FILTER WORKS PERFECTLY FOR SESSIONKEY (QID 3)!');
            output.push('   This proves the filter mechanism is working.');
            output.push('   If student-id (QID 20) filter fails, it\'s a field-specific issue.');
          } else {
            output.push('âš ï¸ Filter returned extra results (partial match?)');
          }
        } else {
          output.push('âŒ No results found - sessionkey may not exist in database');
        }

        resultDiv.textContent = output.join('\n');
        resultDiv.className = result.content?.length > 0 && result.content?.length <= 10 ? 'result success' : 'result warning';
      } catch (error) {
        resultDiv.textContent = `âŒ Error: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    async function testContainsFilter() {
      const resultDiv = document.getElementById('result-contains');
      resultDiv.textContent = 'Testing...';
      resultDiv.className = 'result';

      try {
        const apiKey = document.getElementById('apiKey').value;
        const formId = document.getElementById('formId').value;
        const studentId = document.getElementById('studentId').value;

        // Test :contains operator (QID 20)
        const filter = {"20:contains": studentId};
        const filterEncoded = encodeURIComponent(JSON.stringify(filter));
        
        const url = `https://api.jotform.com/form/${formId}/submissions?` +
                    `apiKey=${apiKey}` +
                    `&filter=${filterEncoded}` +
                    `&limit=1000` +
                    `&orderby=created_at` +
                    `&direction=ASC`;

        console.log('Contains Filter URL:', url);

        const response = await fetch(url);
        const result = await response.json();

        const output = [];
        output.push(`âœ… Status: ${response.status} ${response.statusText}`);
        output.push(`ðŸ“Š Response Code: ${result.responseCode}`);
        output.push(`ðŸ“ Message: ${result.message}`);
        output.push(`ðŸ“¦ Total Submissions: ${result.content?.length || 0}`);
        output.push('');
        output.push('ðŸ” Filter Used (:contains operator):');
        output.push(`   Raw: ${JSON.stringify(filter)}`);
        output.push(`   Encoded: ${filterEncoded}`);
        output.push('');
        output.push('ðŸ“‹ COMPLETE URL (copy to test in browser):');
        output.push(`   ${url}`);
        output.push('');

        if (result.content && result.content.length > 0) {
          output.push('ðŸ“‹ First 10 Student IDs:');
          result.content.slice(0, 10).forEach((sub, idx) => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || 'MISSING';
            const isExact = id === studentId;
            const isPartial = id.includes(studentId) && !isExact;
            const match = isExact ? 'âœ… EXACT' : (isPartial ? 'âš ï¸ PARTIAL' : 'âŒ WRONG');
            output.push(`   [${idx}] ${id} ${match}`);
          });

          const exactMatches = result.content.filter(sub => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || '';
            return id.trim() === studentId;
          });

          const partialMatches = result.content.filter(sub => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || '';
            return id.includes(studentId) && id.trim() !== studentId;
          });

          output.push('');
          output.push(`âœ¨ Exact Matches: ${exactMatches.length} / ${result.content.length}`);
          output.push(`âš ï¸ Partial Matches: ${partialMatches.length} / ${result.content.length}`);
          output.push('');

          if (exactMatches.length > 0) {
            output.push('âœ… SUCCESS: Found exact match(es) for student ' + studentId);
            if (exactMatches.length === result.content.length) {
              output.push('âœ… :contains WORKS PERFECTLY - all returned results are exact!');
            } else {
              output.push('âš ï¸ :contains returned partial matches (expected behavior)');
              output.push(`   Use client-side filtering to get only exact: ${exactMatches.length} matches`);
            }
          } else {
            output.push('âŒ No exact matches found');
          }
        } else {
          output.push('âŒ No submissions found');
        }

        resultDiv.textContent = output.join('\n');
        resultDiv.className = result.content?.length > 0 ? 'result warning' : 'result error';
      } catch (error) {
        resultDiv.textContent = `âŒ Error: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    async function testMatchesFilter() {
      const resultDiv = document.getElementById('result-matches');
      resultDiv.textContent = 'Testing...';
      resultDiv.className = 'result';

      try {
        const apiKey = document.getElementById('apiKey').value;
        const formId = document.getElementById('formId').value;
        const studentId = document.getElementById('studentId').value;

        // Test :matches operator on QID 3 (sessionkey) - as recommended by Jotform support
        const filter = {"q3:matches": studentId};
        const filterEncoded = encodeURIComponent(JSON.stringify(filter));
        
        const url = `https://api.jotform.com/form/${formId}/submissions?` +
                    `apiKey=${apiKey}` +
                    `&filter=${filterEncoded}` +
                    `&limit=1000` +
                    `&orderby=created_at` +
                    `&direction=ASC`;

        console.log('Matches Filter URL:', url);

        const response = await fetch(url);
        const result = await response.json();

        const output = [];
        output.push(`âœ… Status: ${response.status} ${response.statusText}`);
        output.push(`ðŸ“Š Response Code: ${result.responseCode}`);
        output.push(`ðŸ“ Message: ${result.message}`);
        output.push(`ðŸ“¦ Total Submissions: ${result.content?.length || 0}`);
        output.push('');
        output.push('ðŸ” Filter Used (:matches on sessionkey/QID 3):');
        output.push(`   Raw: ${JSON.stringify(filter)}`);
        output.push(`   Encoded: ${filterEncoded}`);
        output.push('');
        output.push('ðŸ“‹ COMPLETE URL (copy to test in browser):');
        output.push(`   ${url}`);
        output.push('');

        if (result.content && result.content.length > 0) {
          output.push('ðŸ“‹ First 10 SessionKeys (QID 3):');
          result.content.slice(0, 10).forEach((sub, idx) => {
            const sessionKey = sub.answers?.['3']?.answer || sub.answers?.['3']?.text || 'MISSING';
            const studentIdInSub = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || 'N/A';
            const containsPattern = sessionKey.includes(studentId);
            const match = containsPattern ? 'âœ… CONTAINS' : 'âŒ NO MATCH';
            output.push(`   [${idx}] ${sessionKey} (Student ID: ${studentIdInSub}) ${match}`);
          });

          // Count how many sessionkeys contain the student ID pattern
          const matchingSubmissions = result.content.filter(sub => {
            const sessionKey = sub.answers?.['3']?.answer || sub.answers?.['3']?.text || '';
            return sessionKey.includes(studentId);
          });

          // Count submissions where student ID field matches
          const studentIdMatches = result.content.filter(sub => {
            const id = sub.answers?.['20']?.answer || sub.answers?.['20']?.text || '';
            return id.trim() === studentId;
          });

          output.push('');
          output.push(`ðŸ“Š SessionKeys containing "${studentId}": ${matchingSubmissions.length} / ${result.content.length}`);
          output.push(`âœ¨ Student ID (QID 20) exact matches: ${studentIdMatches.length} / ${result.content.length}`);
          output.push('');

          if (matchingSubmissions.length > 0) {
            output.push(`âœ… SUCCESS: :matches operator found ${matchingSubmissions.length} submission(s)`);
            output.push('   This searches sessionkey field for pattern matching');
            if (studentIdMatches.length === result.content.length) {
              output.push('âœ… All returned submissions have matching student ID!');
            } else if (studentIdMatches.length > 0) {
              output.push(`âš ï¸ ${studentIdMatches.length} submissions have matching student ID`);
            }
          } else {
            output.push('âŒ No submissions with matching pattern in sessionkey');
          }
        } else {
          output.push('âŒ No submissions found');
        }

        resultDiv.textContent = output.join('\n');
        resultDiv.className = result.content?.length > 0 ? 'result success' : 'result warning';
      } catch (error) {
        resultDiv.textContent = `âŒ Error: ${error.message}`;
        resultDiv.className = 'result error';
      }
    }

    // Auto-run all tests on load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('Test page loaded. Click buttons to run tests.');
    });
  </script>
</body>
</html>
