<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JotForm + Qualtrics Pipeline Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-green { background-color: #10b981; }
        .status-yellow { background-color: #f59e0b; }
        .status-red { background-color: #ef4444; }
        .status-grey { background-color: #9ca3af; }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .step-complete {
            color: #10b981;
        }
        .step-error {
            color: #ef4444;
        }
        .step-pending {
            color: #9ca3af;
        }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        .metric-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass-card p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üî¨ Pipeline Test: JotForm + Qualtrics Merge</h1>
            <p class="text-gray-600 mb-4">Test the complete data pipeline for a specific Core ID</p>
            
            <!-- Documentation Section -->
            <details class="mt-4 p-4 bg-blue-50 rounded-lg">
                <summary class="cursor-pointer font-semibold text-blue-900">üìñ How to Use This Test</summary>
                <div class="mt-3 text-sm text-gray-700 space-y-2">
                    <p><strong>Purpose:</strong> This tool tests the complete JotForm + Qualtrics merge pipeline for a specific student (Core ID) using different fetch strategies.</p>
                    
                    <p class="p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded"><strong>‚ö†Ô∏è CORS Setup Required for Local Testing:</strong></p>
                    <div class="ml-6 p-2 bg-gray-50 rounded">
                        <p>When running this page locally (file:// or localhost without proxy), browsers block API requests due to CORS policy.</p>
                        <p class="mt-2"><strong>Quick Start:</strong></p>
                        <ul class="list-disc ml-6 space-y-1">
                            <li><strong>Windows:</strong> Double-click <code>start_pipeline_test.bat</code> in this folder</li>
                            <li><strong>Linux/Mac:</strong> Run <code>./start_pipeline_test.sh</code> from terminal</li>
                        </ul>
                        <p class="mt-2">These scripts will:</p>
                        <ol class="list-decimal ml-6 space-y-1">
                            <li>Start a local CORS proxy server on http://127.0.0.1:3000</li>
                            <li>Automatically open this test page in your browser</li>
                            <li>Allow API requests to JotForm and Qualtrics to work properly</li>
                        </ol>
                        <p class="mt-2 text-xs text-gray-600"><em>Note: CORS proxy is only needed for local development. GitHub Pages deployment doesn't need this.</em></p>
                    </div>
                    
                    <p><strong>Test Methods:</strong></p>
                    <ul class="list-disc ml-6 space-y-1">
                        <li><strong>Direct API (Slower)</strong> - Fetches data directly from JotForm and Qualtrics APIs for this specific Core ID. Slower but doesn't require pre-cached data.</li>
                        <li><strong>Global Cache (Faster)</strong> - Uses IndexedDB cache to store all submissions, then filters client-side. Much faster for repeated lookups. First run will cache all data.</li>
                        <li><strong>Compare Both</strong> - Runs both methods sequentially and shows performance comparison. Use this to see the speedup from caching.</li>
                    </ul>
                    
                    <p><strong>What it does:</strong></p>
                    <ol class="list-decimal ml-6 space-y-1">
                        <li>Loads credentials from <code>assets/credentials.json</code></li>
                        <li><strong>JotForm Data:</strong> Either uses <code>:matches</code> filter (direct) or global IndexedDB cache (fast)</li>
                        <li><strong>Qualtrics Data:</strong> Uses export-poll-download API flow (can be cached on subsequent runs)</li>
                        <li>Transforms Qualtrics data to standardized format using <code>qualtrics-mapping.json</code></li>
                        <li>Merges JotForm + Qualtrics data by Core ID using "earliest non-empty wins" strategy (same as main system)</li>
                        <li>Validates all tasks using TaskValidator with termination rules and completion metrics</li>
                    </ol>
                    
                    <p><strong>How to use:</strong></p>
                    <ol class="list-decimal ml-6 space-y-1">
                        <li>Enter a numeric Core ID (e.g., <code>10261</code>) - do NOT include the "C" prefix</li>
                        <li>Select a test method:
                            <ul class="list-circle ml-6">
                                <li><strong>Direct API</strong> - Slower, but works without cache</li>
                                <li><strong>Global Cache</strong> - Faster (recommended for testing multiple students)</li>
                                <li><strong>Compare Both</strong> - See performance difference</li>
                            </ul>
                        </li>
                        <li>Click "Run Pipeline Test" button</li>
                        <li>Watch the pipeline steps execute in real-time</li>
                        <li>Review the results: task completion status, light indicators, answered/correct counts</li>
                        <li>Inspect raw data in the debug section if needed</li>
                    </ol>
                    
                    <p><strong>Expected Output:</strong></p>
                    <ul class="list-disc ml-6 space-y-1">
                        <li>Student overview (Core ID, name, submission counts)</li>
                        <li>Task validation results with status lights:
                            <ul class="list-circle ml-6">
                                <li><span class="text-green-600">üü¢ Green</span> - Complete (100%)</li>
                                <li><span class="text-yellow-600">üü° Yellow</span> - Post-term (terminated/timed out)</li>
                                <li><span class="text-red-600">üî¥ Red</span> - Incomplete (&lt;100%)</li>
                                <li><span class="text-gray-600">‚ö™ Grey</span> - Not started (0%)</li>
                            </ul>
                        </li>
                        <li>Summary statistics (count of tasks in each status)</li>
                        <li>Raw data inspector for debugging</li>
                    </ul>
                    
                    <p><strong>Note:</strong> This tool requires <code>credentials.json</code> to be present in the <code>assets/</code> directory with valid JotForm and Qualtrics API credentials.</p>
                </div>
            </details>
        </div>

        <!-- Input Section -->
        <div class="glass-card p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìã Test Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Core ID (numeric only)</label>
                    <input type="text" id="coreIdInput" placeholder="e.g., 10261" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           value="10261">
                    <p class="text-xs text-gray-500 mt-1">Enter numeric Core ID without 'C' prefix</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Test Method</label>
                    <select id="testMethod" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="direct">Direct API (Slower)</option>
                        <option value="cache" selected>Global Cache (Faster)</option>
                        <option value="comparison">Compare Both</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Choose fetch strategy</p>
                </div>
                <div class="flex items-end">
                    <button id="runTestBtn" onclick="runPipelineTest()" 
                            class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-blue-700 transition-all shadow-lg">
                        üöÄ Run Pipeline Test
                    </button>
                </div>
            </div>
            <div id="credentialsStatus" class="text-sm text-gray-600"></div>
        </div>

        <!-- Pipeline Steps -->
        <div class="glass-card p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">‚öôÔ∏è Pipeline Execution Steps</h2>
            
            <!-- Performance Metrics -->
            <div id="performanceMetrics" class="hidden mb-4 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg border border-green-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold text-gray-800">‚ö° Performance Metrics</h3>
                        <p class="text-sm text-gray-600">Total execution time and method comparison</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-green-600" id="totalTime">-</div>
                        <div class="text-xs text-gray-500">Total Time</div>
                    </div>
                </div>
                <div id="comparisonResults" class="hidden mt-3 grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-lg border border-gray-200">
                        <div class="text-xs text-gray-500 uppercase mb-1">Direct API</div>
                        <div class="text-lg font-bold text-gray-800" id="directTime">-</div>
                        <div class="text-xs text-gray-500" id="directSpeed">-</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg border border-gray-200">
                        <div class="text-xs text-gray-500 uppercase mb-1">Global Cache</div>
                        <div class="text-lg font-bold text-green-600" id="cacheTime">-</div>
                        <div class="text-xs text-gray-500" id="cacheSpeed">-</div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <div id="step1" class="flex items-center p-3 bg-gray-50 rounded-lg step-pending">
                    <span class="mr-3">1Ô∏è‚É£</span>
                    <span class="flex-1">Load credentials from credentials.json</span>
                    <span id="step1-status">‚è≥</span>
                </div>
                <div id="step2" class="flex items-center p-3 bg-gray-50 rounded-lg step-pending">
                    <span class="mr-3">2Ô∏è‚É£</span>
                    <span class="flex-1">Fetch JotForm submissions (:matches filter on sessionkey)</span>
                    <span id="step2-status">‚è≥</span>
                </div>
                <div id="step3" class="flex items-center p-3 bg-gray-50 rounded-lg step-pending">
                    <span class="mr-3">3Ô∏è‚É£</span>
                    <span class="flex-1">Fetch Qualtrics TGMD responses (export-poll-download)</span>
                    <span id="step3-status">‚è≥</span>
                </div>
                <div id="step4" class="flex items-center p-3 bg-gray-50 rounded-lg step-pending">
                    <span class="mr-3">4Ô∏è‚É£</span>
                    <span class="flex-1">Transform Qualtrics data to standardized format</span>
                    <span id="step4-status">‚è≥</span>
                </div>
                <div id="step5" class="flex items-center p-3 bg-gray-50 rounded-lg step-pending">
                    <span class="mr-3">5Ô∏è‚É£</span>
                    <span class="flex-1">Merge JotForm + Qualtrics by Core ID</span>
                    <span id="step5-status">‚è≥</span>
                </div>
                <div id="step6" class="flex items-center p-3 bg-gray-50 rounded-lg step-pending">
                    <span class="mr-3">6Ô∏è‚É£</span>
                    <span class="flex-1">Validate all tasks (termination rules + completion metrics)</span>
                    <span id="step6-status">‚è≥</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <!-- Student Overview -->
            <div class="glass-card p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üë§ Student Overview</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="metric-card">
                        <div class="text-xs text-gray-500 uppercase mb-1">Core ID</div>
                        <div id="result-coreid" class="text-lg font-bold text-gray-800">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="text-xs text-gray-500 uppercase mb-1">Student Name</div>
                        <div id="result-name" class="text-lg font-bold text-gray-800">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="text-xs text-gray-500 uppercase mb-1">JotForm Records</div>
                        <div id="result-jotform-count" class="text-lg font-bold text-gray-800">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="text-xs text-gray-500 uppercase mb-1">Qualtrics Records</div>
                        <div id="result-qualtrics-count" class="text-lg font-bold text-gray-800">-</div>
                    </div>
                </div>
            </div>

            <!-- Task Validation Results -->
            <div class="glass-card p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìä Task Validation Results</h2>
                <div id="taskResults" class="space-y-4">
                    <!-- Task cards will be inserted here -->
                </div>
            </div>

            <!-- TGMD Qualtrics Data Section -->
            <div class="glass-card p-6 mb-6" id="tgmdQualtricsSection" style="display: none;">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üéØ TGMD Data from Qualtrics</h2>
                <p class="text-sm text-gray-600 mb-4">Exclusive view of TGMD assessment data retrieved from Qualtrics, showing raw field values and validation results.</p>
                <div id="tgmdQualtricsContent" class="space-y-4">
                    <!-- TGMD Qualtrics data will be inserted here -->
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="glass-card p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìà Summary Statistics</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="metric-card bg-green-50 border-green-200">
                        <div class="flex items-center mb-2">
                            <span class="status-indicator status-green"></span>
                            <span class="text-sm font-medium text-gray-700">Complete</span>
                        </div>
                        <div id="summary-complete" class="text-3xl font-bold text-green-700">0</div>
                    </div>
                    <div class="metric-card bg-yellow-50 border-yellow-200">
                        <div class="flex items-center mb-2">
                            <span class="status-indicator status-yellow"></span>
                            <span class="text-sm font-medium text-gray-700">Post-term</span>
                        </div>
                        <div id="summary-postterm" class="text-3xl font-bold text-yellow-700">0</div>
                    </div>
                    <div class="metric-card bg-red-50 border-red-200">
                        <div class="flex items-center mb-2">
                            <span class="status-indicator status-red"></span>
                            <span class="text-sm font-medium text-gray-700">Incomplete</span>
                        </div>
                        <div id="summary-incomplete" class="text-3xl font-bold text-red-700">0</div>
                    </div>
                    <div class="metric-card bg-gray-50 border-gray-200">
                        <div class="flex items-center mb-2">
                            <span class="status-indicator status-grey"></span>
                            <span class="text-sm font-medium text-gray-700">Not Started</span>
                        </div>
                        <div id="summary-notstarted" class="text-3xl font-bold text-gray-700">0</div>
                    </div>
                </div>
            </div>

            <!-- Raw Data Inspector -->
            <div class="glass-card p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üîç Raw Data Inspector</h2>
                <div class="space-y-4">
                    <details class="cursor-pointer">
                        <summary class="font-semibold text-gray-700 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">JotForm Merged Answers</summary>
                        <pre id="debug-jotform" class="mt-2">-</pre>
                    </details>
                    <details class="cursor-pointer">
                        <summary class="font-semibold text-gray-700 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">Qualtrics Raw API Response</summary>
                        <pre id="debug-qualtrics-raw" class="mt-2">-</pre>
                    </details>
                    <details class="cursor-pointer">
                        <summary class="font-semibold text-gray-700 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">Qualtrics Transformed Data</summary>
                        <pre id="debug-qualtrics" class="mt-2">-</pre>
                    </details>
                    <details class="cursor-pointer">
                        <summary class="font-semibold text-gray-700 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">Merged Data (Final)</summary>
                        <pre id="debug-merged" class="mt-2">-</pre>
                    </details>
                    <details class="cursor-pointer">
                        <summary class="font-semibold text-gray-700 p-3 bg-gray-50 rounded-lg hover:bg-gray-100">Validation Results (Full)</summary>
                        <pre id="debug-validation" class="mt-2">-</pre>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <!-- Load required scripts (from parent directory since we're in TEMP/) -->
    <!-- NOTE: Using test-specific versions of jotform-cache, qualtrics-transformer, and task-validator to avoid modifying shared files -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="jotform-cache-test.js"></script>
    <script src="../assets/js/qualtrics-api.js"></script>
    <script src="qualtrics-transformer-test.js"></script>
    <script src="../assets/js/data-merger.js"></script>
    <script src="grade-detector-test.js"></script>
    <script src="task-validator-test.js"></script>

    <script>
        // Embedded Qualtrics mapping (no need for assets/qualtrics-mapping.json file)
        // This is injected directly into the transformer to avoid 404 errors
        const EMBEDDED_QUALTRICS_MAPPING = {"sessionkey":"sessionkey","jotformsubmissionid":"jotformsubmissionid","Start Date":"startDate;timeZone;Z","End Date":"endDate;timeZone;Z","Response Type":"status","IP Address":"ipAddress","Progress":"progress","Duration (in seconds)":"duration","Finished":"finished","Recorded Date":"recordedDate;timeZone;Z","Response ID":"_recordId","Location Latitude":"locationLatitude","Location Longitude":"locationLongitude","Recipient Last Name":"recipientLastName","Recipient First Name":"recipientFirstName","Recipient Email":"recipientEmail","External Data Reference":"externalDataReference","Distribution Channel":"distributionChannel","student-id":"QID125287935_TEXT","child-name":"studentname","school-id":"QID125287936_TEXT","district":"district","class-id":"classid","class-name":"classname","Gender":"QID125287937","ERV_P1":"QID125470777","ERV_P2":"QID125470778","ERV_P3":"QID125470779","ERV_Q1":"QID125470781","ERV_Q2":"QID125470782","ERV_Q3":"QID125470783","ERV_Q4":"QID125470784","ERV_Q5":"QID125470785","ERV_Q6":"QID125470786","ERV_Q7":"QID125470787","ERV_Q8":"QID125470788","ERV_Q9":"QID125470789","ERV_Q10":"QID125470790","ERV_Q11":"QID125470791","ERV_Q12":"QID125470792","ERV_Ter1":"QID125470793","ERV_Q13":"QID125470794","ERV_Q14":"QID125470795","ERV_Q15":"QID125470796","ERV_Q16":"QID125470797","ERV_Q17":"QID125470798","ERV_Q18":"QID125470799","ERV_Q19":"QID125470800","ERV_Q20":"QID125470801","ERV_Q21":"QID125470802","ERV_Q22":"QID125470803","ERV_Q23":"QID125470804","ERV_Q24":"QID125470805","ERV_Ter2":"QID125470806","ERV_Q25":"QID125470807","ERV_Q26":"QID125470808","ERV_Q27":"QID125470809","ERV_Q28":"QID125470810","ERV_Q29":"QID125470811","ERV_Q30":"QID125470812","ERV_Q31":"QID125470813","ERV_Q32":"QID125470814","ERV_Q33":"QID125470815","ERV_Q34":"QID125470816","ERV_Q35":"QID125470817","ERV_Q36":"QID125470818","ERV_Ter3":"QID125470819","ERV_Q37":"QID125470820","ERV_Q38":"QID125470821","ERV_Q39":"QID125470822","ERV_Q40":"QID125470823","ERV_Q41":"QID125470824","ERV_Q42":"QID125470825","ERV_Q43":"QID125470826","ERV_Q44":"QID125470827","ERV_Q45":"QID125470828","ERV_Q46":"QID125470829","ERV_Q47":"QID125470830","ERV_Q48":"QID125470831","ERV_Date":"QID125471321_TEXT","ERV_Com":"QID125470832","ERV1_Score":"SC_298LGnThb4XD28m","ERV2_Score":"SC_3adFhmCKz7IUPzw","ERV3_Score":"SC_3pKkEm562XUTSmO","ERV4_Score":"SC_7OnZPrMpb6SWPCS","SYM_S1":"QID125470916","SYM_S2":"QID125470917","SYM_S3":"QID125470918","SYM_P1":"QID125470919","SYM_P2":"QID125470920","SYM_P3":"QID125470921","SYM_P4":"QID125470922","SYM_P5":"QID125470923","SYM_P6":"QID125470924","SYM_P7":"QID125470925","SYM_P8":"QID125470926","SYM_P9":"QID125470927","SYM_Timing - First Click":"QID125470929_FIRST_CLICK","SYM_Timing - Last Click":"QID125470929_LAST_CLICK","SYM_Timing - Page Submit":"QID125470929_PAGE_SUBMIT","SYM_Timing - Click Count":"QID125470929_CLICK_COUNT","SYM_Q1":"QID125470930","SYM_Q2":"QID125470931","SYM_Q3":"QID125470932","SYM_Q4":"QID125470933","SYM_Q5":"QID125470934","SYM_Q6":"QID125470935","SYM_Q7":"QID125470936","SYM_Q8":"QID125470937","SYM_Q9":"QID125470938","SYM_Q10":"QID125470939","SYM_Q11":"QID125470940","SYM_Q12":"QID125470941","SYM_Q13":"QID125470942","SYM_Q14":"QID125470943","SYM_Q15":"QID125470944","SYM_Q16":"QID125470945","SYM_Q17":"QID125470946","SYM_Q18":"QID125470947","SYM_Q19":"QID125470948","SYM_Q20":"QID125470949","SYM_Q21":"QID125470950","SYM_Q22":"QID125470951","SYM_Q23":"QID125470952","SYM_Q24":"QID125470953","SYM_Q25":"QID125470954","SYM_Q26":"QID125470955","SYM_Q27":"QID125470956","SYM_Q28":"QID125470957","SYM_Q29":"QID125470958","SYM_Q30":"QID125470959","SYM_Q31":"QID125470960","SYM_Q32":"QID125470961","SYM_Q33":"QID125470962","SYM_Q34":"QID125470963","SYM_Q35":"QID125470964","SYM_Q36":"QID125470965","SYM_Q37":"QID125470966","SYM_Q38":"QID125470967","SYM_Q39":"QID125470968","SYM_Q40":"QID125470969","SYM_Q41":"QID125470970","SYM_Q42":"QID125470971","SYM_Q43":"QID125470972","SYM_Q44":"QID125470973","SYM_Q45":"QID125470974","SYM_Q46":"QID125470975","SYM_Q47":"QID125470976","SYM_Q48":"QID125470977","SYM_Q49":"QID125470978","SYM_Q50":"QID125470979","SYM_Q51":"QID125470980","SYM_Q52":"QID125470981","SYM_Q53":"QID125470982","SYM_Q54":"QID125470983","SYM_Q55":"QID125470984","SYM_Q56":"QID125470985","NONSYM_S1":"QID125470988","NONSYM_S2":"QID125470989","NONSYM_S3":"QID125470990","NONSYM_P1":"QID125470991","NONSYM_P2":"QID125470992","NONSYM_P3":"QID125470993","NONSYM_P4":"QID125470994","NONSYM_P5":"QID125470995","NONSYM_P6":"QID125470996","NONSYM_P7":"QID125470997","NONSYM_P8":"QID125470998","NONSYM_P9":"QID125470999","NONSYM_Timing - First Click":"QID125471001_FIRST_CLICK","NONSYM_Timing - Last Click":"QID125471001_LAST_CLICK","NONSYM_Timing - Page Submit":"QID125471001_PAGE_SUBMIT","NONSYM_Timing - Click Count":"QID125471001_CLICK_COUNT","NONSYM_Q1":"QID125471002","NONSYM_Q2":"QID125471003","NONSYM_Q3":"QID125471004","NONSYM_Q4":"QID125471005","NONSYM_Q5":"QID125471006","NONSYM_Q6":"QID125471007","NONSYM_Q7":"QID125471008","NONSYM_Q8":"QID125471009","NONSYM_Q9":"QID125471010","NONSYM_Q10":"QID125471011","NONSYM_Q11":"QID125471012","NONSYM_Q12":"QID125471013","NONSYM_Q13":"QID125471014","NONSYM_Q14":"QID125471015","NONSYM_Q15":"QID125471016","NONSYM_Q16":"QID125471017","NONSYM_Q17":"QID125471018","NONSYM_Q18":"QID125471019","NONSYM_Q19":"QID125471020","NONSYM_Q20":"QID125471021","NONSYM_Q21":"QID125471022","NONSYM_Q22":"QID125471023","NONSYM_Q23":"QID125471024","NONSYM_Q24":"QID125471025","NONSYM_Q25":"QID125471026","NONSYM_Q26":"QID125471027","NONSYM_Q27":"QID125471028","NONSYM_Q28":"QID125471029","NONSYM_Q29":"QID125471030","NONSYM_Q30":"QID125471031","NONSYM_Q31":"QID125471032","NONSYM_Q32":"QID125471033","NONSYM_Q33":"QID125471034","NONSYM_Q34":"QID125471035","NONSYM_Q35":"QID125471036","NONSYM_Q36":"QID125471037","NONSYM_Q37":"QID125471038","NONSYM_Q38":"QID125471039","NONSYM_Q39":"QID125471040","NONSYM_Q40":"QID125471041","NONSYM_Q41":"QID125471042","NONSYM_Q42":"QID125471043","NONSYM_Q43":"QID125471044","NONSYM_Q44":"QID125471045","NONSYM_Q45":"QID125471046","NONSYM_Q46":"QID125471047","NONSYM_Q47":"QID125471048","NONSYM_Q48":"QID125471049","NONSYM_Q49":"QID125471050","NONSYM_Q50":"QID125471051","NONSYM_Q51":"QID125471052","NONSYM_Q52":"QID125471053","NONSYM_Q53":"QID125471054","NONSYM_Q54":"QID125471055","NONSYM_Q55":"QID125471056","NONSYM_Q56":"QID125471057","SYM_NS_Date":"QID125477892_TEXT","SYM_NS_Com":"QID125471058","Symbolic_number_Score":"SC_86VPVSHhDSQnYyi","SYM Time Used":"SYM_time_used","NONSYM Time Used":"NONSYM_time_used","ToM_Q1a":"QID125471062","ToM_Q1b":"QID125471065","ToM_Q2a":"QID125471068","ToM_Q2b":"QID125471071","ToM_Q3_TEXT":"QID125471072_TEXT","ToM_Q3a":"QID125471074","ToM_Q3a_TEXT":"QID125471074_3_TEXT","ToM_Q3b":"QID125471077","ToM_Q3c":"QID125471078","ToM_Q4a_ins1_TEXT":"QID125471079_TEXT","ToM_Q4a":"QID125471081","ToM_Q4a_TEXT":"QID125471081_2_TEXT","ToM_Q4b":"QID125471084","ToM_Q4c":"QID125471085","ToM_Q5a":"QID125471087","ToM_Q5b":"QID125471088","ToM_P1":"QID125471089","ToM_P2":"QID125471090","ToM_P3":"QID125471091","ToM_Q6a":"QID125471094","ToM_Q6a_TEXT":"QID125471094_2_TEXT","ToM_Q6b":"QID125471097","ToM_Q6c":"QID125471098","ToM_Q7a":"QID125471100","ToM_Q7a_TEXT":"QID125471100_2_TEXT","ToM_Q7b":"QID125471103","ToM_Q7b_TEXT":"QID125471103_2_TEXT","ToM_Q7c":"QID125471106","ToM_Q7d":"QID125471107","ToM_Date":"QID125477893_TEXT","ToM_Score_TEXT":"QID125483481_TEXT","ToM_Com":"QID125471108","TOM_PreChoice":"TOMPreChoice","TOM_CurChoice":"TOMCurChoice","TOM_Score":"TOMScore","CWR_Q1":"QID125470717","CWR_Q2":"QID125470718","CWR_Q3":"QID125470719","CWR_Q4":"QID125470720","CWR_Q5":"QID125470721","CWR_Q6":"QID125470722","CWR_Q7":"QID125470723","CWR_Q8":"QID125470724","CWR_Q9":"QID125470725","CWR_Q10":"QID125470726","CWR_Q11":"QID125470727","CWR_Q12":"QID125470728","CWR_Q13":"QID125470729","CWR_Q14":"QID125470730","CWR_Q15":"QID125470731","CWR_Q16":"QID125470732","CWR_Q17":"QID125470733","CWR_Q18":"QID125470734","CWR_Q19":"QID125470735","CWR_Q20":"QID125470736","CWR_Q21":"QID125470737","CWR_Q22":"QID125470738","CWR_Q23":"QID125470739","CWR_Q24":"QID125470740","CWR_Q25":"QID125470741","CWR_Q26":"QID125470742","CWR_Q27":"QID125470743","CWR_Q28":"QID125470744","CWR_Q29":"QID125470745","CWR_Q30":"QID125470746","CWR_Q31":"QID125470747","CWR_Q32":"QID125470748","CWR_Q33":"QID125470749","CWR_Q34":"QID125470750","CWR_Q35":"QID125470751","CWR_Q36":"QID125470752","CWR_Q37":"QID125470753","CWR_Q38":"QID125470754","CWR_Q39":"QID125470755","CWR_Q40":"QID125470756","CWR_Q41":"QID125470757","CWR_Q42":"QID125470758","CWR_Q43":"QID125470759","CWR_Q44":"QID125470760","CWR_Q45":"QID125470761","CWR_Q46":"QID125470762","CWR_Q47":"QID125470763","CWR_Q48":"QID125470764","CWR_Q49":"QID125470765","CWR_Q50":"QID125470766","CWR_Q51":"QID125470767","CWR_Q52":"QID125470768","CWR_Q53":"QID125470769","CWR_Q54":"QID125470770","CWR_Q55":"QID125470771","CWR_Date":"QID125471317_TEXT","CWR_Com":"QID125470772","CWR_Score":"SC_9tBtQjK2iNYX8oe","CWR_ConsecutiveWrongs":"ConsecutiveWrongs","CWR_Counter":"CWRCounter","CWR_10Incorrect":"CWR_10Incorrect","TEC_M_Q1":"QID125471130","TEC_M_Q2":"QID125471131","TEC_M_Q3":"QID125471132","TEC_M_Q4":"QID125471133","TEC_M_Q5":"QID125471134","TEC_M_Q6":"QID125471136","TEC_M_Q7":"QID125471137","TEC_M_Q8":"QID125471138","TEC_M_Q9":"QID125471139","TEC_M_Q10":"QID125471140","TEC_M_Q11":"QID125471141","TEC_M_Q12":"QID125471142","TEC_M_Q13":"QID125471143","TEC_M_Q14":"QID125471144","TEC_M_Q15":"QID125471145","TEC_M_Q16a":"QID125471148","TEC_M_Q16b":"QID125471149","TEC_M_Q17":"QID125471150","TEC_M_Q18":"QID125471151","TEC_M_Date":"QID125477895_TEXT","TEC_M_Com":"QID125471152","TEC_F_Q1":"QID125471157","TEC_F_Q2":"QID125471158","TEC_F_Q3":"QID125471159","TEC_F_Q4":"QID125471160","TEC_F_Q5":"QID125471161","TEC_F_Q6":"QID125471163","TEC_F_Q7":"QID125471164","TEC_F_Q8":"QID125471165","TEC_F_Q9":"QID125471166","TEC_F_Q10":"QID125471167","TEC_F_Q11":"QID125471168","TEC_F_Q12":"QID125471169","TEC_F_Q13":"QID125471170","TEC_F_Q14":"QID125471171","TEC_F_Q15":"QID125471172","TEC_F_Q16a":"QID125471175","TEC_F_Q16b":"QID125471176","TEC_F_Q17":"QID125471177","TEC_F_Q18":"QID125471178","TEC_F_Date":"QID125477896_TEXT","TEC_F_Com":"QID125471179","MPT_1_r_Q1":"QID125470869","MPT_1_r_Q2":"QID125470870","MPT_1_r_Q3":"QID125470871","MPT_1_r_Q4":"QID125470872","MPT_1_r_Q5":"QID125470873","MPT_1_r_Q6":"QID125470874","MPT_2_gr_Q1":"QID125470876","MPT_2_gr_Q1_TEXT":"QID125470876_5_TEXT","MPT_2_gr_Q2":"QID125470877","MPT_2_gr_Q2_TEXT":"QID125470877_5_TEXT","MPT_2_gr_Q3":"QID125470878","MPT_2_gr_Q3_TEXT":"QID125470878_5_TEXT","MPT_2_gr_Q4":"QID125470879","MPT_2_gr_Q4_TEXT":"QID125470879_5_TEXT","MPT_2_gr_Q5":"QID125470880","MPT_2_gr_Q5_TEXT":"QID125470880_5_TEXT","MPT_2_gr_Q6":"QID125470881","MPT_2_gr_Q6_TEXT":"QID125470881_5_TEXT","MPT_3_m_P1":"QID125470883","MPT_3_m_Q1":"QID125470884","MPT_3_m_Q2":"QID125470885","MPT_3_m_Q3":"QID125470886","MPT_3_m_Q4":"QID125470887","MPT_3_m_Q5":"QID125470888","MPT_3_m_Q6":"QID125470889","MPT_4_ge_Q1":"QID125470891","MPT_4_ge_Q2":"QID125470892","MPT_4_ge_Q3":"QID125470893","MPT_4_ge_Q4":"QID125470894","MPT_4_ge_Q5":"QID125470895","MPT_4_ge_Q6":"QID125470896","MPT_Date":"QID125477890_TEXT","MPT_Com":"QID125470897","MPT_Score":"SC_8jP7AuUtraE8EPc","CCM_Q1":"QID125471117","CCM_Q2":"QID125471118","CCM_Q3":"QID125471119","CCM_Q4":"QID125471120","CCM_Q5":"QID125471121","CCM_Q6":"QID125471122","CCM_Q7":"QID125471123","CCM_Q8":"QID125471124","CCM_Date":"QID125477894_TEXT","CCM_Com":"QID125471125","HTKS_Q1":"QID125958936","HTKS_Q2":"QID125958937","HTKS_Q3":"QID125958938","HTKS_Q4":"QID125958939","HTKS_Q5":"QID125958940","HTKS_Q6":"QID125958946","HTKS_Q7":"QID125958947","HTKS_Q8":"QID125958948","HTKS_Q9":"QID125958949","HTKS_Q10":"QID125958950","HTKS_Q11":"QID125958954","HTKS_Q12":"QID125958955","HTKS_Q13":"QID125958956","HTKS_Q14":"QID125958957","HTKS_Q15":"QID125958958","HTKS_Q16":"QID125958959","HTKS_Memo_TEXT":"QID125958960_TEXT","HTKS_Date":"QID125958961_TEXT","HTKS_Com":"QID125958962","HTKS_Score":"SC_4Ntdld2MzwcHhsy","HTKS_1_Ter":"HTKS_1","EPN_Q1":"QID125959711","EPN_Q2":"QID125959712","EPN_Q3":"QID125959713","EPN_Q4":"QID125959714","EPN_Q5":"QID125959715","EPN_Q6":"QID125959716","EPN_Q7":"QID125959717","EPN_Q8":"QID125959718","EPN_Date":"QID125959719_TEXT","EPN_Com":"QID125959720","CM_P1":"QID125471185","CM_P1_TEXT":"QID125471185_2_TEXT","CM_P2":"QID125471187","CM_P2_TEXT":"QID125471187_2_TEXT","CM_Q1":"QID125471190","CM_Q1_TEXT":"QID125471190_2_TEXT","CM_Q2":"QID125471192","CM_Q2_TEXT":"QID125471192_2_TEXT","CM_Q3":"QID125471194","CM_Q3_TEXT":"QID125471194_2_TEXT","CM_Q4":"QID125471196","CM_Q4_TEXT":"QID125471196_2_TEXT","CM_Q5":"QID125471198","CM_Q5_TEXT":"QID125471198_2_TEXT","CM_Q6":"QID125471200","CM_Q6_TEXT":"QID125471200_2_TEXT","CM_Q7":"QID125471202","CM_Q7_TEXT":"QID125471202_2_TEXT","CM_Ter1":"QID125471203","CM_Q8":"QID125471205","CM_Q8_TEXT":"QID125471205_2_TEXT","CM_Q9":"QID125471207","CM_Q9_TEXT":"QID125471207_2_TEXT","CM_Q10":"QID125471209","CM_Q10_TEXT":"QID125471209_2_TEXT","CM_Q11":"QID125471211","CM_Q11_TEXT":"QID125471211_2_TEXT","CM_Q12":"QID125471213","CM_Q12_TEXT":"QID125471213_2_TEXT","CM_Ter2":"QID125471214","CM_Q13":"QID125471216","CM_Q13_TEXT":"QID125471216_2_TEXT","CM_Q14":"QID125471218","CM_Q14_TEXT":"QID125471218_2_TEXT","CM_Q15":"QID125471220","CM_Q15_TEXT":"QID125471220_2_TEXT","CM_Q16":"QID125471222","CM_Q16_TEXT":"QID125471222_2_TEXT","CM_Q17":"QID125471224","CM_Q17_TEXT":"QID125471224_2_TEXT","CM_Ter3":"QID125471225","CM_Q18":"QID125471227","CM_Q18_TEXT":"QID125471227_2_TEXT","CM_Q19":"QID125471229","CM_Q19_TEXT":"QID125471229_2_TEXT","CM_Q20":"QID125471231","CM_Q20_TEXT":"QID125471231_2_TEXT","CM_Q21":"QID125471233","CM_Q21_TEXT":"QID125471233_2_TEXT","CM_Q22":"QID125471235","CM_Q22_TEXT":"QID125471235_2_TEXT","CM_Ter4":"QID125471236","CM_S5":"CM_S5","CM_Q23":"QID125471238","CM_Q23_TEXT":"QID125471238_4_TEXT","CM_Q24":"QID125471240","CM_Q24_TEXT":"QID125471240_2_TEXT","CM_Q25":"QID125471242","CM_Q25_TEXT":"QID125471242_2_TEXT","CM_Q26":"QID125471244","CM_Q26_TEXT":"QID125471244_2_TEXT","CM_Q27":"QID125471246","CM_Q27_TEXT":"QID125471246_2_TEXT","CM_Date":"QID125477897_TEXT","CM_Com":"QID125471248","CM_K3_Score":"SC_40KEJLLjmpFqV38","CM_P2_Score":"SC_2rvtTw36a5a9LKK","CM_P3_Score":"SC_57nb5c6tLKdbAbk","CM_P4_Score":"SC_6spB3aKum1LXWAK","CM_P5_Score":"SC_0SViVPHF0BGTPIa","FM_Hand":"QID126169732","FM_side_1":"QID125470694","FM_side_2":"QID125470695","FM_side_3":"QID125470696","FM_squ_1":"QID125470697","FM_squ_2":"QID125470698","FM_squ_3":"QID125470699","FM_Ter":"QID125470700","FM_tree_1":"QID125470702","FM_tree_2":"QID125470703","FM_tree_3":"QID125470704","FM_Date":"QID125477883_TEXT","FM_Com":"QID125470706","FM_1_Score":"SC_23krhwtQBMLJu06","FM_2_Score":"SC_8AlP1FZKtrybpKm","TGMD_Hand":"QID126166418","TGMD_Leg":"QID126166419","TGMD_111_Hop_t1":"QID126166420#1_1","TGMD_112_Hop_t1":"QID126166420#1_2","TGMD_113_Hop_t1":"QID126166420#1_3","TGMD_114_Hop_t1":"QID126166420#1_4","TGMD_111_Hop_t2":"QID126166420#2_1","TGMD_112_Hop_t2":"QID126166420#2_2","TGMD_113_Hop_t2":"QID126166420#2_3","TGMD_114_Hop_t2":"QID126166420#2_4","TGMD_211_Jum_t1":"QID126166421#1_1","TGMD_212_Jum_t1":"QID126166421#1_2","TGMD_213_Jum_t1":"QID126166421#1_3","TGMD_214_Jum_t1":"QID126166421#1_4","TGMD_211_Jum_t2":"QID126166421#2_1","TGMD_212_Jum_t2":"QID126166421#2_2","TGMD_213_Jum_t2":"QID126166421#2_3","TGMD_214_Jum_t2":"QID126166421#2_4","TGMD_311_Sli_t1":"QID126166422#1_1","TGMD_312_Sli_t1":"QID126166422#1_2","TGMD_313_Sli_t1":"QID126166422#1_3","TGMD_314_Sli_t1":"QID126166422#1_4","TGMD_311_Sli_t2":"QID126166422#2_1","TGMD_312_Sli_t2":"QID126166422#2_2","TGMD_313_Sli_t2":"QID126166422#2_3","TGMD_314_Sli_t2":"QID126166422#2_4","TGMD_411_Dri_t1":"QID126166423#1_1","TGMD_412_Dri_t1":"QID126166423#1_2","TGMD_413_Dri_t1":"QID126166423#1_3","TGMD_411_Dri_t2":"QID126166423#2_1","TGMD_412_Dri_t2":"QID126166423#2_2","TGMD_413_Dri_t2":"QID126166423#2_3","TGMD_511_Cat_t1":"QID126166424#1_1","TGMD_512_Cat_t1":"QID126166424#1_2","TGMD_513_Cat_t1":"QID126166424#1_3","TGMD_511_Cat_t2":"QID126166424#2_1","TGMD_512_Cat_t2":"QID126166424#2_2","TGMD_513_Cat_t2":"QID126166424#2_3","TGMD_611_Thr_t1":"QID126166425#1_1","TGMD_612_Thr_t1":"QID126166425#1_2","TGMD_613_Thr_t1":"QID126166425#1_3","TGMD_614_Thr_t1":"QID126166425#1_5","TGMD_611_Thr_t2":"QID126166425#2_1","TGMD_612_Thr_t2":"QID126166425#2_2","TGMD_613_Thr_t2":"QID126166425#2_3","TGMD_614_Thr_t2":"QID126166425#2_5","TGMD_Com":"QID126166426","MF_1":"MF_1","MF_2":"MF_2","MF_3":"MF_3","MF_4":"MF_4","MF_5":"MF_5","MF_6":"MF_6","MF_7":"MF_7","MF_8":"MF_8","MF_9":"MF_9","MF_10":"MF_10","MF_11":"MF_11","MF_12":"MF_12","MF_13":"MF_13","MF_14":"MF_14","MF_15":"MF_15","MF_16":"MF_16","MF_17":"MF_17","MF_18":"MF_18","MF_19":"MF_19","MF_20":"MF_20","MF_21":"MF_21","MF_22":"MF_22","MF_23":"MF_23","MF_24":"MF_24","MF_25":"MF_25","MF_26":"MF_26","MF_27":"MF_27","MF_28":"MF_28","MF_29":"MF_29","MF_30":"MF_30","MF_31":"MF_31","MF_32":"MF_32","MF_33":"MF_33","MF_34":"MF_34","MF_35":"MF_35","MF_36":"MF_36","MF_37":"MF_37","MF_38":"MF_38","MF_39":"MF_39","MF_40":"MF_40","MF_41":"MF_41","MF_42":"MF_42","MF_43":"MF_43","MF_44":"MF_44","MF_45":"MF_45","MF_46":"MF_46","MF_47":"MF_47","MF_48":"MF_48","MF Time Used":"MF_time_used","MF_Date":"MF_Date","MF_Com":"MF_Com","Score":"SC_cwfXGU101qz254q","FinishedBlockID":"FinishedBlockID"};
    </script>

    <script>
        // Embedded credentials (no need for credentials.json file)
        let credentials = {
            "supabaseUrl": "https://pscoohsotnsvkdfeksug.supabase.co",
            "supabaseKey": "sb_publishable_ivs8BJf4Kp0cQm__otsVUA__17kXlKG",
            "supabaseProjectId": "pscoohsotnsvkdfeksug",
            "supabaseTable": "qualtrics_credentials",
            "supabaseUploadLogTable": "pdf_upload_log",
            "uploadTable": "qualtrics_uploads",
            "qualtricsDatacenter": "syd1",
            "qualtricsSurveyId": "SV_23Qbs14soOkGo9E",
            "qualtricsApiKey": "raV8YenlxaFuxEZuACFJ9gpl5XKWS7IyHB1ijuhR",
            "qualtricsClientId": "d6ad061427f6d54018c2669dbc56c669",
            "qualtricsClientSecret": "azx1sj1Dz3PpjngKqVqpDkQOFrwdErVCMVzIEzfn2TUWPisF2w5sZxWFS5QmKp70",
            "systemPassword": "ks2.0",
            "jotformApiKey": "f45162cb1d42e5e725ef38c9ccc06915",
            "jotformFormId": "252152307582049",
            "jotformUploadLogFormId": "252170773367461"
        };
        
        let qualtricsMapping = null;
        let jotformQuestionsData = null; // QID to field name mapping
        let performanceData = {}; // Track timing for each method

        // Load credentials on page load
        async function loadCredentials() {
            try {
                // Credentials are now embedded, no fetch needed
                document.getElementById('credentialsStatus').innerHTML = 
                    '<span class="text-green-600">‚úÖ Credentials loaded successfully (embedded)</span>';
                
                console.log('[Test] Credentials loaded:', {
                    jotformFormId: credentials.jotformFormId,
                    qualtricsSurveyId: credentials.qualtricsSurveyId,
                    qualtricsDatacenter: credentials.qualtricsDatacenter
                });

                // Load JotForm questions mapping (QID to field name)
                console.log('[Test] Loading JotForm questions mapping...');
                const questionsResponse = await fetch('../assets/jotformquestions.json');
                jotformQuestionsData = await questionsResponse.json();
                console.log('[Test] JotForm questions mapping loaded:', Object.keys(jotformQuestionsData).length, 'fields');

                // Inject mapping directly into transformer instance to avoid 404
                const transformer = new QualtricsTransformer();
                // Set mapping directly before calling loadMapping() - transformer checks if mapping exists first
                transformer.mapping = EMBEDDED_QUALTRICS_MAPPING;
                transformer.mappingLoaded = true;
                qualtricsMapping = await transformer.loadMapping(); // Will just return the already-set mapping
                console.log('[Test] Qualtrics mapping loaded (embedded)');
                
                return true;
            } catch (error) {
                console.error('[Test] Failed to load credentials:', error);
                document.getElementById('credentialsStatus').innerHTML = 
                    '<span class="text-red-600">‚ùå Failed to load credentials: ' + error.message + '</span>';
                return false;
            }
        }

        // Update step status
        function updateStep(stepNum, status, message = '') {
            const step = document.getElementById(`step${stepNum}`);
            const statusSpan = document.getElementById(`step${stepNum}-status`);
            
            step.classList.remove('step-pending', 'step-complete', 'step-error');
            
            if (status === 'complete') {
                step.classList.add('step-complete');
                statusSpan.textContent = '‚úÖ';
            } else if (status === 'error') {
                step.classList.add('step-error');
                statusSpan.textContent = '‚ùå';
            } else if (status === 'loading') {
                statusSpan.innerHTML = '<div class="loading-spinner"></div>';
            }

            if (message) {
                const messageEl = step.querySelector('.flex-1');
                messageEl.innerHTML = messageEl.textContent.split(' (')[0] + ' <span class="text-xs text-gray-500">(' + message + ')</span>';
            }
        }

        // Main pipeline test function
        async function runPipelineTest() {
            const coreId = document.getElementById('coreIdInput').value.trim();
            const testMethod = document.getElementById('testMethod').value;
            
            if (!coreId) {
                alert('Please enter a Core ID');
                return;
            }

            // Reset UI
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('performanceMetrics').classList.add('hidden');
            document.getElementById('comparisonResults').classList.add('hidden');
            for (let i = 1; i <= 6; i++) {
                updateStep(i, 'pending');
            }

            const runBtn = document.getElementById('runTestBtn');
            runBtn.disabled = true;
            runBtn.textContent = '‚è≥ Running Test...';

            const startTime = performance.now();

            try {
                // Step 1: Load Credentials
                updateStep(1, 'loading');
                const credsLoaded = await loadCredentials();
                if (!credsLoaded) {
                    updateStep(1, 'error', 'Failed to load credentials');
                    return;
                }
                updateStep(1, 'complete');

                let results;
                
                if (testMethod === 'comparison') {
                    // Run both methods and compare
                    results = await runComparisonTest(coreId);
                } else if (testMethod === 'cache') {
                    // Use global cache method
                    results = await runCacheMethod(coreId);
                } else {
                    // Use direct API method
                    results = await runDirectMethod(coreId);
                }

                const endTime = performance.now();
                const totalTime = ((endTime - startTime) / 1000).toFixed(2);
                
                // Show performance metrics
                document.getElementById('performanceMetrics').classList.remove('hidden');
                document.getElementById('totalTime').textContent = `${totalTime}s`;
                
                if (testMethod === 'comparison') {
                    document.getElementById('comparisonResults').classList.remove('hidden');
                    const directTime = performanceData.direct || 0;
                    const cacheTime = performanceData.cache || 0;
                    const speedup = (directTime / cacheTime).toFixed(1);
                    
                    document.getElementById('directTime').textContent = `${directTime.toFixed(2)}s`;
                    document.getElementById('cacheTime').textContent = `${cacheTime.toFixed(2)}s`;
                    document.getElementById('directSpeed').textContent = 'Baseline';
                    document.getElementById('cacheSpeed').textContent = `${speedup}x faster`;
                }

                // Display Results
                displayResults(results);

            } catch (error) {
                console.error('[Test] Pipeline test failed:', error);
                alert('Pipeline test failed: ' + error.message);
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'üöÄ Run Pipeline Test';
            }
        }

        // Run test using direct API calls
        async function runDirectMethod(coreId) {
            console.log('[Test] ========== USING DIRECT API METHOD ==========');
            const methodStart = performance.now();
            
            // Step 2: Fetch JotForm Data
            updateStep(2, 'loading');
            const jotformData = await fetchJotFormData(coreId);
            updateStep(2, 'complete', `${jotformData.submissions.length} submissions found`);

            // Step 3: Fetch Qualtrics Data
            updateStep(3, 'loading');
            const qualtricsData = await fetchQualtricsData(coreId);
            updateStep(3, 'complete', `${qualtricsData.responses.length} responses found`);

            // Step 4: Transform Qualtrics Data
            updateStep(4, 'loading');
            const transformedQualtrics = await transformQualtricsData(qualtricsData.responses);
            updateStep(4, 'complete', `${transformedQualtrics.length} records transformed`);

            // Step 5: Merge Data
            updateStep(5, 'loading');
            const mergedData = await mergeData(jotformData.jotformRecords, transformedQualtrics, coreId);
            updateStep(5, 'complete', 'Data merged successfully');

            // Step 6: Validate Tasks
            updateStep(6, 'loading');
            const validationResults = await validateTasks(mergedData);
            updateStep(6, 'complete', `${Object.keys(validationResults).length} tasks validated`);

            const methodEnd = performance.now();
            performanceData.direct = (methodEnd - methodStart) / 1000;

            return {
                coreId,
                jotformData,
                qualtricsData,
                transformedQualtrics,
                mergedData,
                validationResults,
                method: 'Direct API'
            };
        }

        // Run test using global cache
        async function runCacheMethod(coreId) {
            console.log('[Test] ========== USING GLOBAL CACHE METHOD ==========');
            const methodStart = performance.now();
            
            // Step 2: Fetch JotForm Data from Cache
            updateStep(2, 'loading');
            const jotformData = await fetchJotFormDataFromCache(coreId);
            updateStep(2, 'complete', `${jotformData.submissions.length} submissions found (cached)`);

            // Step 3: Fetch Qualtrics Data from Cache
            updateStep(3, 'loading');
            const qualtricsData = await fetchQualtricsDataFromCache(coreId);
            updateStep(3, 'complete', `${qualtricsData.responses.length} responses found (cached)`);

            // Step 4: Transform Qualtrics Data
            updateStep(4, 'loading');
            const transformedQualtrics = await transformQualtricsData(qualtricsData.responses);
            updateStep(4, 'complete', `${transformedQualtrics.length} records transformed`);

            // Step 5: Merge Data
            updateStep(5, 'loading');
            const mergedData = await mergeData(jotformData.jotformRecords, transformedQualtrics, coreId);
            updateStep(5, 'complete', 'Data merged successfully');

            // Step 6: Validate Tasks
            updateStep(6, 'loading');
            const validationResults = await validateTasks(mergedData);
            updateStep(6, 'complete', `${Object.keys(validationResults).length} tasks validated`);

            const methodEnd = performance.now();
            performanceData.cache = (methodEnd - methodStart) / 1000;

            return {
                coreId,
                jotformData,
                qualtricsData,
                transformedQualtrics,
                mergedData,
                validationResults,
                method: 'Global Cache'
            };
        }

        // Run both methods and compare
        async function runComparisonTest(coreId) {
            console.log('[Test] ========== RUNNING COMPARISON TEST ==========');
            
            // Run direct method first
            const directResults = await runDirectMethod(coreId);
            
            // Reset steps for cache method
            for (let i = 2; i <= 6; i++) {
                updateStep(i, 'pending');
            }
            
            // Run cache method
            const cacheResults = await runCacheMethod(coreId);
            
            // Return cache results (they should be identical)
            return cacheResults;
        }

        // Fetch JotForm data using global cache
        async function fetchJotFormDataFromCache(coreId) {
            console.log('[Test] ========== FETCHING JOTFORM DATA (CACHE) ==========');
            console.log('[Test] Core ID:', coreId);

            if (!window.JotFormCache) {
                throw new Error('JotFormCache not available');
            }

            const { jotformApiKey, jotformFormId } = credentials;
            
            // Get all submissions from cache (will fetch from API if not cached)
            const allSubmissions = await window.JotFormCache.getAllSubmissions({
                formId: jotformFormId,
                apiKey: jotformApiKey
            });

            console.log(`[Test] Retrieved ${allSubmissions.length} total submissions from cache`);

            // Filter for this Core ID
            const submissions = window.JotFormCache.filterByCoreId(allSubmissions, coreId);
            
            console.log(`[Test] ‚úÖ Filtered to ${submissions.length} submissions for Core ID ${coreId}`);

            // Merge multiple submissions for the same student
            const mergedAnswers = mergeJotFormSubmissions(submissions);
            
            return { submissions, mergedAnswers };
        }

        // Fetch Qualtrics data from cache/API
        async function fetchQualtricsDataFromCache(coreId) {
            console.log('[Test] ========== FETCHING QUALTRICS DATA (CACHE) ==========');
            console.log('[Test] Core ID:', coreId);

            if (!window.QualtricsAPI) {
                throw new Error('QualtricsAPI not available');
            }

            const { qualtricsApiKey, qualtricsDatacenter, qualtricsSurveyId } = credentials;

            // Initialize API instance
            const qualtricsAPI = new window.QualtricsAPI();

            // Fetch all responses (QualtricsAPI may implement caching internally)
            const allResponses = await qualtricsAPI.fetchAllResponses({
                qualtricsApiToken: qualtricsApiKey,
                qualtricsDatacenter: qualtricsDatacenter,
                qualtricsSurveyId: qualtricsSurveyId
            });

            console.log(`[Test] ‚úÖ Downloaded ${allResponses.length} total responses`);
            
            // DEBUG: Log structure of first response to understand data format
            if (allResponses.length > 0) {
                console.log('[Test] DEBUG: First response structure:', allResponses[0]);
                console.log('[Test] DEBUG: First response values:', allResponses[0].values);
                if (allResponses[0].values) {
                    const keys = Object.keys(allResponses[0].values);
                    console.log(`[Test] DEBUG: Available fields in values (${keys.length} total):`, keys.slice(0, 20));
                }
            }

            // Filter for this Core ID using the correct QID from Qualtrics
            // According to qualtrics-mapping.json: "student-id": "QID125287935_TEXT"
            const filtered = allResponses.filter(r => {
                const responseCoreId = r.values?.QID125287935_TEXT || r.values?.coreId || r.values?.coreid;
                return responseCoreId === coreId || 
                       responseCoreId === `C${coreId}` ||
                       responseCoreId === coreId.replace(/^C/, '');
            });

            console.log(`[Test] Filtered to ${filtered.length} responses for Core ID ${coreId}`);

            return { responses: filtered, rawResponses: filtered, allResponses: allResponses.length };
        }

        // Fetch JotForm data using :matches filter
        async function fetchJotFormData(coreId) {
            console.log('[Test] ========== FETCHING JOTFORM DATA ==========');
            console.log('[Test] Core ID:', coreId);

            const { jotformApiKey, jotformFormId } = credentials;
            
            // Use :matches filter on sessionkey (QID 3)
            const filter = { "q3:matches": coreId };
            
            const url = `https://api.jotform.com/form/${jotformFormId}/submissions?` +
                        `apiKey=${jotformApiKey}` +
                        `&filter=${encodeURIComponent(JSON.stringify(filter))}` +
                        `&limit=1000` +
                        `&orderby=created_at` +
                        `&direction=ASC`;

            console.log('[Test] Filter:', JSON.stringify(filter));
            console.log('[Test] Fetching from JotForm API...');

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`JotForm API error: ${response.status}`);
            }

            const data = await response.json();
            const submissions = data.content || [];
            
            console.log(`[Test] ‚úÖ Received ${submissions.length} submissions`);

            // Transform submissions to records (no merging - production DataMerger will handle that)
            const jotformRecords = transformJotFormSubmissions(submissions);
            
            return { submissions, jotformRecords };
        }

        // Transform JotForm submissions to records format for DataMerger
        // This matches the production transformSubmissionsToRecords logic
        function transformJotFormSubmissions(submissions) {
            console.log('[Test] Transforming JotForm submissions to records...');
            
            if (submissions.length === 0) {
                return [];
            }

            // Create reverse mapping: QID -> field name
            const qidToFieldName = {};
            if (jotformQuestionsData) {
                for (const [fieldName, qid] of Object.entries(jotformQuestionsData)) {
                    qidToFieldName[qid] = fieldName;
                }
            }

            const records = [];
            
            for (const submission of submissions) {
                const record = {
                    coreId: submission.answers?.['3']?.answer, // sessionkey contains coreId
                    sessionkey: submission.answers?.['3']?.answer || submission.answers?.['3']?.text,
                    created_at: submission.created_at,
                    _meta: {
                        source: 'jotform',
                        submissionId: submission.id
                    }
                };
                
                // Map all answers from QID to field names
                const answers = submission.answers || {};
                for (const [qid, answerObj] of Object.entries(answers)) {
                    const fieldName = qidToFieldName[qid];
                    if (fieldName) {
                        const value = answerObj.answer || answerObj.text;
                        if (value) {
                            record[fieldName] = value;
                        }
                    }
                }
                
                if (record.coreId) {
                    records.push(record);
                }
            }

            console.log(`[Test] Transformed ${records.length} submissions to records`);
            return records;
        }

        // Fetch Qualtrics data
        async function fetchQualtricsData(coreId) {
            console.log('[Test] ========== FETCHING QUALTRICS DATA ==========');
            console.log('[Test] Core ID:', coreId);

            const { qualtricsApiKey, qualtricsDatacenter, qualtricsSurveyId } = credentials;
            const baseUrl = `https://${qualtricsDatacenter}.qualtrics.com/API/v3`;

            // Step 1: Start export
            console.log('[Test] Starting export...');
            const exportResponse = await fetch(
                `${baseUrl}/surveys/${qualtricsSurveyId}/export-responses`,
                {
                    method: 'POST',
                    headers: {
                        'X-API-TOKEN': qualtricsApiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        format: 'json',
                        compress: false
                    })
                }
            );

            if (!exportResponse.ok) {
                throw new Error(`Qualtrics export start failed: ${exportResponse.status}`);
            }

            const exportData = await exportResponse.json();
            const progressId = exportData.result.progressId;
            console.log('[Test] Export started, progress ID:', progressId);

            // Step 2: Poll for completion
            let fileId = null;
            let attempts = 0;
            const maxAttempts = 30;

            while (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
                
                const progressResponse = await fetch(
                    `${baseUrl}/surveys/${qualtricsSurveyId}/export-responses/${progressId}`,
                    {
                        headers: { 'X-API-TOKEN': qualtricsApiKey }
                    }
                );

                const progressData = await progressResponse.json();
                const status = progressData.result.status;
                const percentComplete = progressData.result.percentComplete;

                console.log(`[Test] Export progress: ${percentComplete}% (${status})`);

                if (status === 'complete') {
                    fileId = progressData.result.fileId;
                    console.log('[Test] ‚úÖ Export complete, file ID:', fileId);
                    break;
                } else if (status === 'failed') {
                    throw new Error('Qualtrics export failed');
                }

                attempts++;
            }

            if (!fileId) {
                throw new Error('Qualtrics export timeout');
            }

            // Step 3: Download file
            console.log('[Test] Downloading responses...');
            const fileResponse = await fetch(
                `${baseUrl}/surveys/${qualtricsSurveyId}/export-responses/${fileId}/file`,
                {
                    headers: { 'X-API-TOKEN': qualtricsApiKey }
                }
            );

            if (!fileResponse.ok) {
                throw new Error(`Qualtrics file download failed: ${fileResponse.status}`);
            }

            const responseData = await fileResponse.json();
            const responses = responseData.responses || [];
            
            console.log(`[Test] ‚úÖ Downloaded ${responses.length} total responses`);
            
            // DEBUG: Log structure of first response to understand data format
            if (responses.length > 0) {
                console.log('[Test] DEBUG: First response structure:', responses[0]);
                console.log('[Test] DEBUG: First response values:', responses[0].values);
                if (responses[0].values) {
                    const keys = Object.keys(responses[0].values);
                    console.log(`[Test] DEBUG: Available fields in values (${keys.length} total):`, keys.slice(0, 20));
                }
            }

            // Filter for this Core ID using the correct QID from Qualtrics
            // According to qualtrics-mapping.json: "student-id": "QID125287935_TEXT"
            const filtered = responses.filter(r => {
                const responseCoreId = r.values?.QID125287935_TEXT || r.values?.coreId || r.values?.coreid;
                // Match with or without C prefix
                return responseCoreId === coreId || 
                       responseCoreId === `C${coreId}` ||
                       responseCoreId === coreId.replace(/^C/, '');
            });

            console.log(`[Test] Filtered to ${filtered.length} responses for Core ID ${coreId}`);

            return { responses: filtered, rawResponses: filtered, allResponses: responses.length };
        }

        // Transform Qualtrics data
        async function transformQualtricsData(responses) {
            console.log('[Test] ========== TRANSFORMING QUALTRICS DATA ==========');
            
            if (!window.QualtricsTransformer) {
                console.warn('[Test] QualtricsTransformer not available, returning raw data');
                return responses;
            }

            const transformer = new window.QualtricsTransformer();
            await transformer.loadMapping();

            const transformed = responses.map(response => {
                return transformer.transformResponse(response);
            });

            console.log(`[Test] ‚úÖ Transformed ${transformed.length} responses`);
            return transformed;
        }

        // Merge JotForm + Qualtrics data using "earliest non-empty wins" strategy
        // This matches the merge logic in jotform-cache.js (line 795-815)
        // Also groups data by grade (K1/K2/K3) for separate display
        // Merge JotForm + Qualtrics data using production DataMerger
        // This ensures test-pipeline uses the SAME logic as production
        async function mergeData(jotformRecords, qualtricsRecords, coreId) {
            console.log('[Test] ========== MERGING DATA (Production DataMerger) ==========');
            console.log('[Test] JotForm records:', jotformRecords.length);
            console.log('[Test] Qualtrics records:', qualtricsRecords.length);

            // Use production DataMerger for consistency
            const merger = new window.DataMerger();
            const mergedRecords = merger.mergeDataSources(jotformRecords, qualtricsRecords);
            
            console.log(`[Test] ‚úÖ Merged into ${mergedRecords.length} record(s)`);
            
            // Group results by grade for display
            const dataByGrade = {};
            for (const record of mergedRecords) {
                const grade = record.grade || 'Unknown';
                if (!dataByGrade[grade]) {
                    dataByGrade[grade] = {
                        records: [],
                        merged: null
                    };
                }
                dataByGrade[grade].records.push(record);
                
                // For display, use the first record's data as "merged"
                if (!dataByGrade[grade].merged) {
                    dataByGrade[grade].merged = record;
                }
            }
            
            console.log('[Test] ‚úÖ Data grouped by grade:', Object.keys(dataByGrade).join(', '));
            
            return dataByGrade;
        }

        // Validate tasks using TaskValidator
        // Now accepts dataByGrade object and validates each grade separately
        async function validateTasks(dataByGrade) {
            console.log('[Test] ========== VALIDATING TASKS ==========');
            
            if (!window.TaskValidator) {
                throw new Error('TaskValidator not available');
            }

            const validationByGrade = {};
            
            for (const [grade, gradeData] of Object.entries(dataByGrade)) {
                console.log(`[Test] Validating grade ${grade}...`);
                const results = await window.TaskValidator.validateAllTasks(gradeData.merged);
                validationByGrade[grade] = results;
                console.log(`[Test] ‚úÖ Validated ${Object.keys(results).length} tasks for grade ${grade}`);
            }
            
            return validationByGrade;
        }

        // Display results - now shows separate results for each grade (K1/K2/K3)
        // Display TGMD data from Qualtrics exclusively
        function displayTGMDQualtricsData(data) {
            console.log('[Test] Displaying TGMD Qualtrics data...');
            
            const section = document.getElementById('tgmdQualtricsSection');
            const container = document.getElementById('tgmdQualtricsContent');
            
            let hasTGMDData = false;
            container.innerHTML = '';
            
            // Check all Qualtrics records for TGMD fields
            for (const response of data.transformedQualtrics) {
                const tgmdFields = {};
                
                // Extract all TGMD fields from this record
                for (const [key, value] of Object.entries(response)) {
                    if (key.startsWith('TGMD_') && !key.startsWith('_')) {
                        tgmdFields[key] = value;
                    }
                }
                
                // If this record has TGMD data, display it
                if (Object.keys(tgmdFields).length > 0) {
                    hasTGMDData = true;
                    
                    const recordDate = response.recordedDate || response._meta?.startDate || 'Unknown';
                    const grade = response.grade || (window.GradeDetector?.determineGradeFromRecordedDate(recordDate)) || 'Unknown';
                    
                    const recordCard = document.createElement('div');
                    recordCard.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50';
                    recordCard.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded bg-purple-100 text-purple-800 text-xs font-semibold">
                                    ${grade}
                                </span>
                                <span class="text-sm text-gray-600">
                                    ${new Date(recordDate).toLocaleString()}
                                </span>
                            </div>
                            <span class="text-xs text-gray-500">
                                ${Object.keys(tgmdFields).length} TGMD fields
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3">
                            ${Object.entries(tgmdFields).map(([field, value]) => `
                                <div class="text-xs">
                                    <div class="font-mono text-gray-500 truncate" title="${field}">${field}</div>
                                    <div class="font-semibold text-gray-800">${value !== null && value !== undefined ? value : '‚Äî'}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <details class="mt-3">
                            <summary class="text-xs text-blue-600 cursor-pointer hover:text-blue-800">View Full JSON</summary>
                            <pre class="mt-2 text-xs bg-white p-2 rounded border border-gray-200 overflow-x-auto">${JSON.stringify(tgmdFields, null, 2)}</pre>
                        </details>
                    `;
                    
                    container.appendChild(recordCard);
                }
            }
            
            // Show/hide section based on whether TGMD data exists
            if (hasTGMDData) {
                section.style.display = 'block';
                console.log('[Test] ‚úÖ TGMD Qualtrics data displayed');
            } else {
                section.style.display = 'none';
                console.log('[Test] ‚ÑπÔ∏è  No TGMD data found in Qualtrics records');
            }
        }

        function displayResults(data) {
            console.log('[Test] ========== DISPLAYING RESULTS ==========');
            
            // Show results section
            document.getElementById('resultsSection').classList.remove('hidden');

            // Student Overview
            document.getElementById('result-coreid').textContent = `C${data.coreId}`;
            
            // Get student name from first available merged data
            let studentName = 'Unknown';
            for (const gradeData of Object.values(data.mergedData)) {
                const childName = gradeData.merged['child-name'] || gradeData.merged['21'];
                if (childName) {
                    studentName = childName.answer || childName.text || 'Unknown';
                    break;
                }
            }
            document.getElementById('result-name').textContent = studentName + (data.method ? ` (${data.method})` : '');
            
            document.getElementById('result-jotform-count').textContent = data.jotformData.submissions.length;
            document.getElementById('result-qualtrics-count').textContent = data.qualtricsData.responses.length;

            // Task Results - grouped by grade
            const taskContainer = document.getElementById('taskResults');
            taskContainer.innerHTML = '';
            
            let totalComplete = 0, totalPostterm = 0, totalIncomplete = 0, totalNotstarted = 0;
            
            // Sort grades: K1, K2, K3, then Unknown
            const gradeOrder = ['K1', 'K2', 'K3', 'Unknown'];
            const sortedGrades = Object.keys(data.validationResults).sort((a, b) => {
                const indexA = gradeOrder.indexOf(a);
                const indexB = gradeOrder.indexOf(b);
                return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
            });
            
            for (const grade of sortedGrades) {
                const validationResults = data.validationResults[grade];
                const gradeData = data.mergedData[grade];
                
                // Add grade section header
                const gradeHeader = document.createElement('div');
                gradeHeader.className = 'mb-4 mt-6';
                gradeHeader.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-3">
                        <span class="px-3 py-1 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white text-sm">
                            ${grade}
                        </span>
                        <span class="text-sm font-normal text-gray-600">
                            (${gradeData.qualtrics.length} Qualtrics records, 
                            ${Object.keys(gradeData.jotform).length > 0 ? 'JotForm data present' : 'No JotForm data'})
                        </span>
                    </h3>
                `;
                taskContainer.appendChild(gradeHeader);
                
                let complete = 0, postterm = 0, incomplete = 0, notstarted = 0;

                for (const [taskId, result] of Object.entries(validationResults)) {
                    const completionPct = result.completionPercentage || 0;
                    const accuracyPct = result.accuracyPercentage || 0;
                    
                    // Determine status
                    let status = 'grey';
                    let statusText = 'Not Started';
                    
                    if (completionPct === 0) {
                        status = 'grey';
                        statusText = 'Not Started';
                        notstarted++;
                    } else if (completionPct === 100) {
                        status = 'green';
                        statusText = 'Complete';
                        complete++;
                    } else if (result.terminated || result.timedOut) {
                        status = 'yellow';
                        statusText = result.timedOut ? 'Timed Out' : 'Terminated';
                        postterm++;
                    } else {
                        status = 'red';
                        statusText = 'Incomplete';
                        incomplete++;
                    }

                    const taskCard = `
                        <div class="metric-card">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <span class="status-indicator status-${status}"></span>
                                    <span class="font-semibold text-gray-800">${result.title || taskId}</span>
                                </div>
                                <span class="text-xs px-2 py-1 rounded-full bg-${status === 'green' ? 'green' : status === 'yellow' ? 'yellow' : status === 'red' ? 'red' : 'gray'}-100 text-${status === 'green' ? 'green' : status === 'yellow' ? 'yellow' : status === 'red' ? 'red' : 'gray'}-700">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-sm">
                                <div>
                                    <div class="text-xs text-gray-500">Answered</div>
                                    <div class="font-bold text-gray-800">${result.answeredQuestions || 0}/${result.totalQuestions || 0}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Correct</div>
                                    <div class="font-bold text-gray-800">${result.correctAnswers || 0}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Accuracy</div>
                                    <div class="font-bold text-gray-800">${accuracyPct.toFixed(0)}%</div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>Progress</span>
                                    <span>${completionPct.toFixed(0)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-${status === 'green' ? 'green' : status === 'yellow' ? 'yellow' : status === 'red' ? 'red' : 'gray'}-500 h-2 rounded-full transition-all" style="width: ${completionPct}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    taskContainer.insertAdjacentHTML('beforeend', taskCard);
                }
                
                // Add grade summary
                const gradeSummary = document.createElement('div');
                gradeSummary.className = 'mb-6 p-4 bg-gray-50 rounded-lg';
                gradeSummary.innerHTML = `
                    <div class="text-sm font-semibold text-gray-700 mb-2">${grade} Summary:</div>
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div><span class="status-indicator status-green"></span>Complete: ${complete}</div>
                        <div><span class="status-indicator status-yellow"></span>Post-term: ${postterm}</div>
                        <div><span class="status-indicator status-red"></span>Incomplete: ${incomplete}</div>
                        <div><span class="status-indicator status-grey"></span>Not Started: ${notstarted}</div>
                    </div>
                `;
                taskContainer.appendChild(gradeSummary);
                
                // Add to totals
                totalComplete += complete;
                totalPostterm += postterm;
                totalIncomplete += incomplete;
                totalNotstarted += notstarted;
            }

            // Summary Statistics (totals across all grades)
            document.getElementById('summary-complete').textContent = totalComplete;
            document.getElementById('summary-postterm').textContent = totalPostterm;
            document.getElementById('summary-incomplete').textContent = totalIncomplete;
            document.getElementById('summary-notstarted').textContent = totalNotstarted;

            // TGMD Qualtrics Section - Display TGMD data from Qualtrics exclusively
            displayTGMDQualtricsData(data);

            // Debug Data - show first grade's data as example
            const firstGrade = sortedGrades[0];
            if (firstGrade && data.mergedData[firstGrade]) {
                document.getElementById('debug-jotform').textContent = 
                    JSON.stringify(data.jotformData.mergedAnswers, null, 2).substring(0, 5000) + '...';
                document.getElementById('debug-qualtrics-raw').textContent = 
                    JSON.stringify(data.qualtricsData.rawResponses, null, 2).substring(0, 5000) + '...';
                document.getElementById('debug-qualtrics').textContent = 
                    JSON.stringify(data.transformedQualtrics, null, 2).substring(0, 5000) + '...';
                document.getElementById('debug-merged').textContent = 
                    JSON.stringify(data.mergedData, null, 2).substring(0, 5000) + '...';
                document.getElementById('debug-validation').textContent = 
                    JSON.stringify(data.validationResults, null, 2);
            }

            console.log('[Test] ‚úÖ Results displayed successfully');
        }

        // Load credentials on page load
        window.addEventListener('DOMContentLoaded', loadCredentials);
    </script>
</body>
</html>
