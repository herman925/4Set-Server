<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/tailwind.config.js"></script>
    <link rel="stylesheet" href="assets/css/theme_pantone_light_1.css" />
    <link rel="stylesheet" href="assets/css/index.css" />
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body class="min-h-screen hero-background">
    <div class="relative overflow-hidden">
        <!-- Decorative Background Elements -->
        <div class="fixed inset-x-0 top-0 h-32 bg-gradient-to-b from-white/70 to-transparent pointer-events-none"></div>
        <div class="fixed inset-0 pointer-events-none z-0">
            <div class="absolute -left-24 top-24 w-48 h-48 rounded-full border border-primary/20 glow-ring"></div>
            <div class="absolute right-12 bottom-20 w-40 h-40 rounded-full border border-secondary/30 glow-ring-secondary"></div>
            <div class="absolute left-1/3 top-1/2 w-20 h-20 rounded-full bg-secondary/20 blur-3xl"></div>
            <div class="absolute right-1/4 top-1/3 w-24 h-24 rounded-full bg-primary/20 blur-3xl"></div>
        </div>

        <!-- Persistent Navigation Bar -->
        <header class="relative z-20 bg-white/80 backdrop-blur-md border-b border-[color:var(--border)] shadow-sm sticky top-0">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                        <a href="index.html" title="Return to 4Set Entry Point" class="p-2 rounded-full hover:bg-[color:var(--muted)] text-[color:var(--muted-foreground)] hover:text-[color:var(--primary)] transition-colors">
                            <i data-lucide="home" class="w-4 h-4"></i>
                        </a>
                        <button id="back-button" class="hero-button secondary-button flex items-center gap-2 px-3 py-1.5 text-xs font-semibold">
                            <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                            <span>Back</span>
                        </button>
                        <nav class="breadcrumb-nav text-xs text-[color:var(--muted-foreground)] flex items-center gap-1.5 font-mono">
                            <a href="#" class="breadcrumb-region px-2 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors">—</a>
                            <i data-lucide="chevron-right" class="w-3 h-3 text-slate-400"></i>
                            <a href="#" class="breadcrumb-group px-2 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors">—</a>
                            <i data-lucide="chevron-right" class="w-3 h-3 text-slate-400"></i>
                            <a href="#" class="breadcrumb-school px-2 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors">—</a>
                            <i data-lucide="chevron-right" class="w-3 h-3 text-slate-400"></i>
                            <a href="#" class="breadcrumb-class px-2 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors">—</a>
                            <i data-lucide="chevron-right" class="w-3 h-3 text-slate-400"></i>
                            <span class="breadcrumb-student px-2 py-1 rounded bg-blue-50 text-blue-700 font-semibold">—</span>
                        </nav>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-[color:var(--muted-foreground)] hidden md:block">Snapshot · 2025-10-08 11:45</span>
                        <button class="hero-button secondary-button text-xs font-medium rounded-md px-3 py-1.5 inline-flex items-center gap-1.5">
                            <i data-lucide="download" class="w-3.5 h-3.5 flex-shrink-0"></i>
                            <span>Export</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-4">
            <!-- Student Profile Panel -->
            <details class="entry-card p-4 lg:p-6 border-l-4 border-l-[color:var(--primary)]">
                <summary class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between cursor-pointer list-none">
                    <div>
                        <h2 class="text-sm font-semibold text-[color:var(--foreground)]">Profile of <span id="student-name">黃子晴 (Chloe Wong)</span></h2>
                        <p class="text-xs text-[color:var(--muted-foreground)] mt-1">Tap to expand or collapse the student identifiers panel</p>
                    </div>
                    <span class="text-[11px] text-[color:var(--muted-foreground)]">Last synced · 2025-10-08 11:45</span>
                </summary>
                <div class="mt-4 pt-4 border-t border-[color:var(--border)]">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3 text-xs">
                        <div class="border border-[color:var(--border)] rounded-lg p-3 bg-gradient-to-br from-white to-[color:var(--muted)]/40">
                            <p class="text-[10px] uppercase text-[color:var(--muted-foreground)] tracking-wide mb-1">Student ID</p>
                            <p class="text-base font-semibold text-[color:var(--foreground)] font-mono"><span id="student-student-id">St10001</span> <span class="text-xs text-[color:var(--muted-foreground)] font-sans">(<span id="student-core-id">C12345</span>)</span></p>
                        </div>
                        <div class="border border-[color:var(--border)] rounded-lg p-3 bg-gradient-to-br from-white to-[color:var(--muted)]/40">
                            <p class="text-[10px] uppercase text-[color:var(--muted-foreground)] tracking-wide mb-1">Gender</p>
                            <p class="text-base font-semibold text-[color:var(--foreground)]" id="student-gender">F</p>
                        </div>
                        <div class="border border-[color:var(--border)] rounded-lg p-3 bg-gradient-to-br from-white to-[color:var(--muted)]/40">
                            <p class="text-[10px] uppercase text-[color:var(--muted-foreground)] tracking-wide mb-1">School</p>
                            <p class="text-base font-semibold text-[color:var(--foreground)]" id="student-school-name">星光小學 <span class="text-xs text-[color:var(--muted-foreground)]">(Starlight Primary)</span></p>
                        </div>
                        <div class="border border-[color:var(--border)] rounded-lg p-3 bg-gradient-to-br from-white to-[color:var(--muted)]/40">
                            <p class="text-[10px] uppercase text-[color:var(--muted-foreground)] tracking-wide mb-1">District</p>
                            <p class="text-base font-semibold text-[color:var(--foreground)]" id="student-district">沙田區</p>
                        </div>
                        <div class="border border-[color:var(--border)] rounded-lg p-3 bg-gradient-to-br from-white to-[color:var(--muted)]/40">
                            <p class="text-[10px] uppercase text-[color:var(--muted-foreground)] tracking-wide mb-1">Class (25/26)</p>
                            <p class="text-base font-semibold text-[color:var(--foreground)]" id="student-class-name">G3A · Starlight P3A</p>
                        </div>
                        <div class="border border-[color:var(--border)] rounded-lg p-3 bg-gradient-to-br from-white to-[color:var(--muted)]/40">
                            <p class="text-[10px] uppercase text-[color:var(--muted-foreground)] tracking-wide mb-1">Group</p>
                            <p class="text-base font-semibold text-[color:var(--foreground)]" id="student-group">3</p>
                        </div>
                    </div>
                </div>
            </details>

            <!-- Task Status Overview -->
            <details class="entry-card p-4 lg:p-6 border-l-4 border-l-[color:var(--secondary)]">
                <summary class="flex items-center justify-between cursor-pointer list-none">
                    <h2 class="text-sm font-semibold text-[color:var(--foreground)]">Task Status Overview</h2>
                    <span class="text-[11px] text-[color:var(--muted-foreground)]">Tap to expand overview metrics</span>
                </summary>
                <div class="mt-4 pt-4 border-t border-[color:var(--border)] grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-white to-green-50 rounded-lg border border-green-200 px-4 py-3 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="status-circle status-green"></span>
                            <h3 class="text-xs text-[color:var(--muted-foreground)] font-medium">Complete</h3>
                        </div>
                        <p class="text-2xl font-bold text-green-700" id="overview-complete-count">—</p>
                    </div>
                    <div class="bg-gradient-to-br from-white to-yellow-50 rounded-lg border border-yellow-200 px-4 py-3 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="status-circle status-yellow"></span>
                            <h3 class="text-xs text-[color:var(--muted-foreground)] font-medium">Post-term</h3>
                        </div>
                        <p class="text-2xl font-bold text-yellow-700" id="overview-postterm-count">—</p>
                    </div>
                    <div class="bg-gradient-to-br from-white to-red-50 rounded-lg border border-red-200 px-4 py-3 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="status-circle status-red"></span>
                            <h3 class="text-xs text-[color:var(--muted-foreground)] font-medium">Incomplete</h3>
                        </div>
                        <p class="text-2xl font-bold text-red-700" id="overview-incomplete-count">—</p>
                    </div>
                    <div class="bg-gradient-to-br from-white to-slate-50 rounded-lg border border-slate-200 px-4 py-3 shadow-sm">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="status-circle status-grey"></span>
                            <h3 class="text-xs text-[color:var(--muted-foreground)] font-medium">Not started</h3>
                        </div>
                        <p class="text-2xl font-bold text-slate-700" id="overview-notstarted-count">—</p>
                    </div>
                </div>
            </details>

            <!-- Task Progress -->
            <section class="entry-card border-l-4 border-l-[color:var(--accent)]">
                <div class="p-4 lg:p-6 border-b border-[color:var(--border)]">
                    <div class="flex flex-col gap-3">
                        <!-- Row 1: Title and Main Controls -->
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                            <div>
                                <h2 class="text-sm font-semibold text-[color:var(--foreground)]">Task Progress</h2>
                                <p class="text-xs text-[color:var(--muted-foreground)] mt-1">Expand a task to review individual questions, responses, and correctness</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2">
                                <div class="flex items-center gap-2 text-xs">
                                    <label for="task-filter" class="font-medium text-[color:var(--foreground)]">Task view</label>
                                    <select id="task-filter" name="task-filter" class="px-2 py-1 border border-[color:var(--border)] rounded-md bg-white text-xs text-[color:var(--foreground)] shadow-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--ring)]">
                                        <option value="all" selected>All tasks</option>
                                        <option value="completed">Completed</option>
                                        <option value="incomplete">Incomplete</option>
                                        <option value="issues">Issues</option>
                                        <option value="not-started">Not started</option>
                                    </select>
                                </div>
                                <button id="expand-all-tasks" class="hero-button secondary-button px-3 py-1.5 rounded-lg text-xs font-medium inline-flex items-center gap-1.5">
                                    <i data-lucide="chevrons-down" class="w-3.5 h-3.5"></i>
                                    <span>Expand All</span>
                                </button>
                                <button id="collapse-all-tasks" class="hero-button secondary-button px-3 py-1.5 rounded-lg text-xs font-medium inline-flex items-center gap-1.5">
                                    <i data-lucide="chevrons-up" class="w-3.5 h-3.5"></i>
                                    <span>Collapse All</span>
                                </button>
                                <button class="hero-button btn-secondary px-4 py-2 rounded-lg text-xs font-medium inline-flex items-center gap-2">
                                    <i data-lucide="sliders" class="w-3.5 h-3.5"></i>
                                    <span>Task Config</span>
                                </button>
                            </div>
                        </div>
                        <!-- Row 2: Status Legends (aligned with Task view label on desktop) -->
                        <div class="flex items-center gap-2 text-xs text-[color:var(--muted-foreground)] pt-2 border-t border-[color:var(--border)]">
                            <span class="inline-flex items-center gap-1"><span class="status-circle status-green"></span>Complete</span>
                            <span class="inline-flex items-center gap-1"><span class="status-circle status-yellow"></span>Post-term</span>
                            <span class="inline-flex items-center gap-1"><span class="status-circle status-red"></span>Incomplete</span>
                            <span class="inline-flex items-center gap-1"><span class="status-circle status-grey"></span>Not started</span>
                        </div>
                    </div>
                </div>
                <div class="divide-y divide-[color:var(--border)]">
                    <!-- Sets will be dynamically populated here by JavaScript -->
                </div>
            </section>
        </main>
    </div>

    <!-- Loading Overlay REMOVED - Cache should already be ready from home page -->
    <!-- If slow loading occurs, data fetches from cache (instant) not API -->

    <!-- Task Config Modal -->
    <div id="task-config-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 backdrop-blur-sm px-4">
        <div class="w-full max-w-3xl space-y-6 rounded-2xl bg-gradient-to-br from-white to-slate-50 p-8 shadow-2xl ring-1 ring-black/5">
            <!-- Header -->
            <div class="flex items-start justify-between pb-4 border-b border-slate-200">
                <div>
                    <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                        <i data-lucide="sliders" class="w-5 h-5 text-[color:var(--primary)]"></i>
                        Task Visibility Configuration
                    </h3>
                    <p class="text-sm text-slate-600 mt-1">Toggle tasks on or off to customize your view</p>
                </div>
                <button id="task-config-close" class="rounded-full p-2 hover:bg-slate-100 transition-colors" title="Close modal" aria-label="Close modal">
                    <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                </button>
            </div>
            
            <!-- Bulk Actions -->
            <div class="flex items-center gap-3 pb-4 border-b border-slate-200">
                <button id="task-select-all" class="px-4 py-2 text-xs font-semibold rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200 hover:bg-emerald-100 transition-colors inline-flex items-center gap-2">
                    <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                    Select All
                </button>
                <button id="task-unselect-all" class="px-4 py-2 text-xs font-semibold rounded-lg bg-slate-50 text-slate-700 border border-slate-200 hover:bg-slate-100 transition-colors inline-flex items-center gap-2">
                    <i data-lucide="circle" class="w-3.5 h-3.5"></i>
                    Unselect All
                </button>
                <div class="flex-1"></div>
                <span id="task-selection-count" class="text-xs text-slate-600 font-mono">0 / 0 selected</span>
            </div>
            
            <!-- Task Pills Grid -->
            <div id="task-config-list" class="max-h-[50vh] overflow-y-auto">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <!-- Pills will be inserted here -->
                </div>
            </div>
            
            <!-- Actions -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
                <button id="task-config-reset" class="px-5 py-2.5 text-sm font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 transition-colors inline-flex items-center gap-2 shadow-sm">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    Reset
                </button>
                <button id="task-config-cancel" class="px-5 py-2.5 text-sm font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 transition-colors shadow-sm">
                    Cancel
                </button>
                <button id="task-config-apply" class="px-5 py-2.5 text-sm font-semibold rounded-lg bg-gradient-to-r from-blue-600 to-blue-700 text-white hover:from-blue-700 hover:to-blue-800 transition-all shadow-md hover:shadow-lg inline-flex items-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Apply Changes
                </button>
            </div>
        </div>
    </div>

    <!-- REMOVED: Old student-data-processor.js and student-ui-renderer.js system -->
    <!-- Now using checking-system-student-page.js which mirrors processor_agent.ps1 -->
    
    <!-- Core scripts -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script><!-- IndexedDB wrapper -->
    <script src="assets/js/encryption.js"></script>
    <script src="assets/js/checking-system-data-loader.js"></script>
    <script src="assets/js/checking-system-router.js"></script>
    <script src="assets/js/jotform-cache.js"></script><!-- MUST load before jotform-api.js -->
    <script src="assets/js/jotform-api.js"></script>
    <script src="assets/js/task-validator.js"></script>
    <script src="assets/js/checking-system-student-page.js"></script>
    
    <!-- Initialize Lucide Icons -->
    <script>
        if (typeof lucide !== 'undefined') {
            try {
                lucide.createIcons();
            } catch (error) {
                console.error('[Main] Failed to initialize icons:', error);
            }
        }
    </script>
</body>
</html>