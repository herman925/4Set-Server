<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Agent Logs - 4Set Pipeline</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/tailwind.config.js"></script>
    <link rel="stylesheet" href="assets/css/theme_pantone_light_1.css" />
    <link rel="stylesheet" href="assets/css/index.css" />
    <link rel="stylesheet" href="assets/css/global.css" />
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        /* Log Level Pills - Compact */
        .log-level-pill {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .log-level-INFO {
            background-color: rgba(43, 57, 144, 0.1);
            color: var(--primary);
            border: 1px solid rgba(43, 57, 144, 0.2);
        }
        
        .log-level-DEBUG {
            background-color: rgba(70, 82, 117, 0.08);
            color: var(--muted-foreground);
            border: 1px solid rgba(70, 82, 117, 0.15);
        }
        
        .log-level-WARN {
            background-color: rgba(244, 208, 54, 0.15);
            color: var(--warning);
            border: 1px solid rgba(244, 208, 54, 0.3);
        }
        
        .log-level-ERROR {
            background-color: rgba(240, 78, 105, 0.1);
            color: var(--destructive);
            border: 1px solid rgba(240, 78, 105, 0.25);
        }
        
        .log-level-REJECT {
            background-color: rgba(240, 78, 105, 0.15);
            color: var(--destructive);
            border: 1px solid rgba(240, 78, 105, 0.3);
            font-weight: 700;
        }
        
        .log-level-UPLOAD {
            background-color: rgba(141, 190, 80, 0.15);
            color: var(--success);
            border: 1px solid rgba(141, 190, 80, 0.3);
        }
        
        .log-level-FILED {
            background-color: rgba(141, 190, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(141, 190, 80, 0.25);
        }
        
        .log-level-DATA_OVERWRITE_DIFF {
            background-color: rgba(249, 157, 51, 0.15);
            color: var(--secondary);
            border: 1px solid rgba(249, 157, 51, 0.3);
            font-weight: 700;
        }
        
        .log-row:hover { background-color: var(--muted); }
        
        /* File Type Badges */
        .file-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .file-type-pdf {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .file-type-edat3 {
            background-color: rgba(139, 92, 246, 0.1);
            color: #7c3aed;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        /* File Type Filter Buttons */
        .file-type-filter {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }
        
        .file-type-filter.active {
            font-weight: 600;
        }
        
        .file-type-filter:hover {
            opacity: 0.85;
        }
        
        .duration-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        /* Ultra-Compact Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            font-size: 0.6rem;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.6rem;
            padding: 1px;
            min-height: 20px;
        }
        
        .calendar-day.empty {
            cursor: default;
            color: #e5e7eb;
        }
        
        .calendar-day.weekend {
            background-color: #fef3e2;
        }
        
        .calendar-day.no-log {
            background-color: #f9fafb;
            color: var(--muted-foreground);
        }
        
        .calendar-day.no-log:hover {
            background-color: #f3f4f6;
        }
        
        .calendar-day.no-log.weekend {
            background-color: #fef3e2;
        }
        
        .calendar-day.has-log {
            background-color: #1e40af;
            color: white;
            font-weight: 700;
        }
        
        .calendar-day.has-log:hover {
            background-color: #1e3a8a;
        }
        
        .calendar-day.has-log.weekend {
            background-color: #c2410c;
            color: white;
            font-weight: 700;
        }
        
        .calendar-day.selected {
            background-color: var(--primary);
            color: white;
        }
        
        .calendar-day.today {
            border: 2px solid var(--secondary);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinning {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen hero-background">
    <div class="relative overflow-hidden">
        <!-- Decorative Background Elements -->
        <div id="background-circles"></div>
        <div class="absolute inset-x-0 top-0 h-32 bg-gradient-to-b from-white/70 to-transparent"></div>

        <main class="relative z-10 mx-auto min-h-screen w-full max-w-6xl px-4 py-6 lg:py-8">
            
            <!-- Header Section - Compact -->
            <div class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex items-center gap-3">
                    <i data-lucide="file-text" class="w-6 h-6 text-[color:var(--primary)]"></i>
                    <h1 class="text-xl sm:text-2xl font-bold tracking-tight text-[color:var(--foreground)]">Processing Agent Logs</h1>
                </div>
                <a href="upload.html" class="hero-button secondary-button flex items-center gap-1.5 px-4 py-2 text-xs font-semibold self-start">
                    <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
                    <span>Back</span>
                </a>
            </div>

            <!-- Two-Column Layout: Date Picker (20%) + Log Viewer (80%) -->
            <div class="grid grid-cols-12 gap-4">
                <!-- LEFT SIDEBAR: Date Picker (20%) -->
                <div class="col-span-12 lg:col-span-3">
                    <div class="entry-card p-4 sticky top-4">
                        <h2 class="text-sm font-semibold text-[color:var(--foreground)] mb-3 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-4 h-4 text-[color:var(--primary)]"></i>
                            Select Date
                        </h2>
                        
                        <!-- Quick Actions -->
                        <div class="flex flex-col gap-1.5 mb-3">
                            <button 
                                onclick="loadToday()"
                                class="w-full px-2 py-1.5 text-xs font-medium rounded-lg transition-all text-left flex items-center gap-1.5"
                                style="background-color: rgba(249, 157, 51, 0.1); color: var(--secondary); border: 1px solid rgba(249, 157, 51, 0.2);"
                            >
                                <i data-lucide="calendar-check" class="w-3 h-3"></i>
                                Today
                            </button>
                            <button 
                                onclick="refreshCurrentLog()"
                                id="refreshBtn"
                                class="w-full px-2 py-1.5 text-xs font-medium text-white rounded-lg transition-all flex flex-col items-start gap-0.5"
                                style="background-color: var(--primary);"
                                disabled
                            >
                                <div class="flex items-center gap-1.5">
                                    <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                    Resync Online
                                </div>
                                <span id="lastRefreshTime" class="text-[0.6rem] opacity-75" style="display: none;"></span>
                            </button>
                            <button 
                                onclick="resyncLocal()"
                                class="w-full px-2 py-1.5 text-xs font-medium rounded-lg transition-all flex items-center gap-1.5"
                                style="background-color: rgba(70, 82, 117, 0.1); color: var(--muted-foreground); border: 1px solid rgba(70, 82, 117, 0.2);"
                            >
                                <i data-lucide="search" class="w-3 h-3"></i>
                                Resync Local
                            </button>
                        </div>
                        
                        <!-- Calendar Navigation -->
                        <div class="flex items-center justify-between mb-2">
                            <button 
                                onclick="changeMonth(-1)"
                                class="p-1 rounded hover:bg-gray-100"
                            >
                                <i data-lucide="chevron-left" class="w-3.5 h-3.5" style="color: var(--primary);"></i>
                            </button>
                            <h3 class="text-xs font-semibold" style="color: var(--foreground);" id="calendarTitle">
                                
                            </h3>
                            <button 
                                onclick="changeMonth(1)"
                                class="p-1 rounded hover:bg-gray-100"
                            >
                                <i data-lucide="chevron-right" class="w-3.5 h-3.5" style="color: var(--primary);"></i>
                            </button>
                        </div>
                        
                        <!-- Compact Calendar -->
                        <div class="calendar-grid mb-1">
                            <div class="text-center text-[0.6rem] font-medium text-[color:var(--muted-foreground)] py-0.5">S</div>
                            <div class="text-center text-[0.6rem] font-medium text-[color:var(--muted-foreground)] py-0.5">M</div>
                            <div class="text-center text-[0.6rem] font-medium text-[color:var(--muted-foreground)] py-0.5">T</div>
                            <div class="text-center text-[0.6rem] font-medium text-[color:var(--muted-foreground)] py-0.5">W</div>
                            <div class="text-center text-[0.6rem] font-medium text-[color:var(--muted-foreground)] py-0.5">T</div>
                            <div class="text-center text-[0.6rem] font-medium text-[color:var(--muted-foreground)] py-0.5">F</div>
                            <div class="text-center text-[0.6rem] font-medium text-[color:var(--muted-foreground)] py-0.5">S</div>
                        </div>
                        <div id="calendar" class="calendar-grid"></div>
                    </div>
                </div>

                <!-- RIGHT MAIN CONTENT: Filters + Logs (80%) -->
                <div class="col-span-12 lg:col-span-9">
                    <!-- Filters Card - Compact -->
                    <div class="entry-card p-3 mb-3">
                        <div class="flex flex-wrap items-center gap-3">
                            <!-- Session Key Filter -->
                            <div class="flex items-center gap-1.5">
                                <label class="text-[0.65rem] font-medium text-[color:var(--muted-foreground)]">File:</label>
                                <input 
                                    type="text" 
                                    id="fileFilter" 
                                    placeholder="Search..."
                                    class="w-32 px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-[color:var(--primary)]"
                                    style="border-color: var(--border);"
                                />
                            </div>

                            <!-- Level Filter -->
                            <div class="flex items-center gap-1.5">
                                <label class="text-[0.65rem] font-medium text-[color:var(--muted-foreground)]">Level:</label>
                                <select 
                                    id="levelFilter"
                                    class="px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-[color:var(--primary)]"
                                    style="border-color: var(--border);"
                                >
                                    <option value="">All</option>
                                    <option value="INFO">INFO</option>
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="WARN">WARN</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="REJECT">REJECT</option>
                                    <option value="UPLOAD">UPLOAD</option>
                                    <option value="FILED">FILED</option>
                                </select>
                            </div>

                            <!-- School ID Filter -->
                            <div class="flex items-center gap-1.5">
                                <label class="text-[0.65rem] font-medium text-[color:var(--muted-foreground)]">School:</label>
                                <select 
                                    id="schoolFilter"
                                    class="px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-[color:var(--primary)]"
                                    style="border-color: var(--border);"
                                >
                                    <option value="">All Schools</option>
                                </select>
                            </div>

                            <!-- Quick Filters -->
                            <div class="flex gap-1">
                                <button onclick="showOnlyErrors()" class="px-2 py-1 text-[0.65rem] font-medium rounded transition-all" style="background-color: rgba(240, 78, 105, 0.1); color: var(--destructive);">Errors</button>
                                <button onclick="showOnlySuccess()" class="px-2 py-1 text-[0.65rem] font-medium rounded transition-all" style="background-color: rgba(141, 190, 80, 0.1); color: var(--success);">Success</button>
                                <button onclick="clearFilters()" class="px-2 py-1 text-[0.65rem] font-medium rounded transition-all" style="background-color: rgba(70, 82, 117, 0.08); color: var(--muted-foreground);">Clear</button>
                            </div>
                        </div>
                    </div>

                    <!-- File Processing Summary (separate card) -->
                    <div class="entry-card mb-3" id="timingsContainer" style="display: none;">
                        <div class="p-3">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-xs font-semibold text-[color:var(--foreground)] flex items-center gap-1.5">
                                    <i data-lucide="clock" class="w-3.5 h-3.5 text-[color:var(--primary)]"></i>
                                    File Summary
                                </h2>
                                <!-- Compact Stats -->
                                <div class="flex items-center gap-2 text-xs" id="statsContainer">
                                    <span class="file-type-badge file-type-pdf" title="PDF files">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                                        <span id="statPdfCount">0</span>
                                    </span>
                                    <span class="file-type-badge file-type-edat3" title="E-Prime files">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
                                        <span id="statEdat3Count">0</span>
                                    </span>
                                    <span class="text-[color:var(--muted-foreground)]">Avg:</span>
                                    <span class="font-semibold" style="color: var(--primary);" id="statAvgTime">0s</span>
                                </div>
                            </div>
                            <!-- File Type Filter -->
                            <div class="mb-2 flex items-center gap-1.5">
                                <button onclick="setFileTypeFilter('all')" id="filterAll" class="file-type-filter active" style="background-color: rgba(70, 82, 117, 0.1); color: var(--foreground);">All</button>
                                <button onclick="setFileTypeFilter('pdf')" id="filterPdf" class="file-type-filter" style="background-color: rgba(239, 68, 68, 0.08); color: #dc2626;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>PDF
                                </button>
                                <button onclick="setFileTypeFilter('edat3')" id="filterEdat3" class="file-type-filter" style="background-color: rgba(139, 92, 246, 0.08); color: #7c3aed;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>E-Prime
                                </button>
                            </div>
                            <div id="timingsTable"></div>
                        </div>
                    </div>

                    <!-- Log Table (separate card) -->
                    <div class="entry-card">
                        <div class="p-3">
                            <!-- Header with Stats -->
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-xs font-semibold text-[color:var(--foreground)] flex items-center gap-1.5">
                                    <i data-lucide="list" class="w-3.5 h-3.5 text-[color:var(--primary)]"></i>
                                    Log Entries
                                </h2>
                                <div class="flex items-center gap-2 text-xs">
                                    <span class="text-[color:var(--muted-foreground)]">Rows:</span>
                                    <span class="font-semibold text-[color:var(--foreground)]" id="statTotal">0</span>
                                    <span class="text-[color:var(--muted-foreground)]">Errors:</span>
                                    <span class="font-semibold" style="color: var(--destructive);" id="statRejects">0</span>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y" style="border-color: var(--border);">
                                    <thead>
                                        <tr>
                                            <th class="px-2 py-1 text-left text-[0.65rem] font-medium text-[color:var(--muted-foreground)] uppercase">Time</th>
                                            <th class="px-2 py-1 text-left text-[0.65rem] font-medium text-[color:var(--muted-foreground)] uppercase">Level</th>
                                            <th class="px-2 py-1 text-left text-[0.65rem] font-medium text-[color:var(--muted-foreground)] uppercase">File</th>
                                            <th class="px-2 py-1 text-left text-[0.65rem] font-medium text-[color:var(--muted-foreground)] uppercase">Message</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logTableBody" class="divide-y" style="border-color: var(--border);">
                                        <tr>
                                            <td colspan="4" class="px-2 py-4 text-center text-[color:var(--muted-foreground)] text-xs">
                                                Select a log date to view entries
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End of right column -->
            </div>
            <!-- End of grid layout -->
        </main>
    </div>

    <script>
        let allLogs = [];
        let filteredLogs = [];
        let currentDate = null;
        let availableLogDates = new Set();
        let currentMonth = new Date();
        let logDirectory = './logs';
        let scanDays = 90;
        let logsDirectoryHandle = null; // File System Access API handle
        let defaultLogSource = 'local';
        let activeLogSource = 'local';
        let logSource = 'local'; // kept for backwards compatibility / logging
        let supabaseConfig = null;
        let supabaseDayCache = new Map();
        let currentFileTypeFilter = 'all'; // 'all', 'pdf', 'edat3'
        let fileToSchoolMap = new Map(); // Maps filename to school ID (e.g., "11751_20251209_09_19.pdf" -> "S075")

        // Helper: Extract school ID from log messages for a file
        // Looks for patterns like "â†’ S075/" in FILED messages or "school-id: 75 â†’ S075" in INFO messages
        function extractSchoolIdFromLogs(logs, filename) {
            for (const log of logs) {
                if (log.file !== filename) continue;
                
                // Pattern 1: FILED messages have "filename â†’ S###/"
                if (log.level === 'FILED') {
                    const match = log.message.match(/â†’\s*(S\d{3})\/?/);
                    if (match) return match[1];
                }
                
                // Pattern 2: INFO messages have "Formatted school-id: ## â†’ S###"
                if (log.level === 'INFO' && log.message.includes('school-id')) {
                    const match = log.message.match(/â†’\s*(S\d{3})/);
                    if (match) return match[1];
                }
                
                // Pattern 3: INFO messages have "Added District: ... (from S###)"
                if (log.level === 'INFO' && log.message.includes('Added District')) {
                    const match = log.message.match(/\(from\s+(S\d{3})\)/);
                    if (match) return match[1];
                }
            }
            return null;
        }

        // Build file-to-school mapping from all logs
        function buildFileToSchoolMap() {
            fileToSchoolMap.clear();
            const uniqueFiles = new Set(allLogs.filter(log => log.file).map(log => log.file));
            
            uniqueFiles.forEach(filename => {
                const schoolId = extractSchoolIdFromLogs(allLogs, filename);
                if (schoolId) {
                    fileToSchoolMap.set(filename, schoolId);
                }
            });
        }

        // Update school filter dropdown with available schools
        function updateSchoolFilterOptions() {
            const schoolFilter = document.getElementById('schoolFilter');
            const currentValue = schoolFilter.value;
            
            // Get unique schools from the map
            const schools = new Set(fileToSchoolMap.values());
            const sortedSchools = Array.from(schools).sort();
            
            // Rebuild options
            schoolFilter.innerHTML = '<option value="">All Schools</option>';
            sortedSchools.forEach(schoolId => {
                const option = document.createElement('option');
                option.value = schoolId;
                option.textContent = schoolId;
                schoolFilter.appendChild(option);
            });
            
            // Restore selection if still valid
            if (currentValue && sortedSchools.includes(currentValue)) {
                schoolFilter.value = currentValue;
            }
        }

        // Helper: Detect file type from filename
        function getFileType(filename) {
            if (!filename) return 'unknown';
            const lower = filename.toLowerCase();
            if (lower.endsWith('.pdf')) return 'pdf';
            if (lower.endsWith('.edat3')) return 'edat3';
            // Also detect edat3 by pattern: TaskName-SchoolId-CoreId-ComputerNo
            if (/^[a-z0-9]+-\d+-\d+-\d+$/i.test(lower.replace('.edat3', ''))) return 'edat3';
            return 'unknown';
        }

        // Helper: Get file type badge HTML - use inline SVG for reliable rendering
        function getFileTypeBadge(filename) {
            const type = getFileType(filename);
            if (type === 'pdf') {
                // Lucide file-text icon as inline SVG
                return `<span class="file-type-badge file-type-pdf" title="PDF Assessment">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                </span>`;
            } else if (type === 'edat3') {
                // Lucide database icon as inline SVG
                return `<span class="file-type-badge file-type-edat3" title="E-Prime Data">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
                </span>`;
            }
            return '';
        }

        // File type filter
        function setFileTypeFilter(filter) {
            currentFileTypeFilter = filter;
            
            // Clear file search input when clicking "All" to reset the full list
            if (filter === 'all') {
                document.getElementById('fileFilter').value = '';
            }
            
            // Update button states
            document.getElementById('filterAll').classList.toggle('active', filter === 'all');
            document.getElementById('filterPdf').classList.toggle('active', filter === 'pdf');
            document.getElementById('filterEdat3').classList.toggle('active', filter === 'edat3');
            
            applyFilters();
        }

        // Request access to logs directory using File System Access API
        async function requestLogsDirectoryAccess() {
            if (!('showDirectoryPicker' in window)) {
                console.warn('File System Access API not supported');
                return false;
            }
            
            // Show instructions before opening picker
            const proceed = confirm(
                'ðŸ“ Select Logs Folder\n\n' +
                'Please navigate to and select the "logs" folder:\n\n' +
                'Path: OneDrive/.../4Set-Server/logs/\n\n' +
                'This folder contains files like:\n' +
                'â€¢ 20251107_processing_agent.csv\n' +
                'â€¢ 20251106_processing_agent.csv\n\n' +
                'Click OK to open folder picker.'
            );
            
            if (!proceed) return false;
            
            try {
                logsDirectoryHandle = await window.showDirectoryPicker({
                    mode: 'read',
                    startIn: 'documents'
                });
                
                // Verify it's the correct folder by checking for expected files
                if (logsDirectoryHandle.name !== 'logs') {
                    const confirmWrong = confirm(
                        `âš ï¸ Warning: You selected "${logsDirectoryHandle.name}"\n\n` +
                        'Expected folder name: "logs"\n\n' +
                        'Continue anyway?'
                    );
                    if (!confirmWrong) {
                        logsDirectoryHandle = null;
                        return false;
                    }
                }
                
                return true;
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Failed to get directory access:', error);
                }
                return false;
            }
        }

        // Switch to local mode and rescan local logs
        async function resyncLocal() {
            activeLogSource = 'local';
            await scanLogFiles('local');
            if (currentDate) {
                await loadLogFile(currentDate);
            }
        }

        // Read file from File System Access API
        async function readFileFromHandle(filename) {
            if (!logsDirectoryHandle) return null;
            
            try {
                const fileHandle = await logsDirectoryHandle.getFileHandle(filename);
                const file = await fileHandle.getFile();
                return await file.text();
            } catch (error) {
                return null;
            }
        }

        // Check if file exists in directory handle
        async function fileExistsInHandle(filename) {
            if (!logsDirectoryHandle) return false;
            
            try {
                await logsDirectoryHandle.getFileHandle(filename);
                return true;
            } catch {
                return false;
            }
        }

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('config/checking_system_config.json');
                const config = await response.json();
                
                const agentResponse = await fetch('config/agent.json');
                const agentConfig = await agentResponse.json();
                logDirectory = agentConfig.logDirectory || './logs';
                
                if (config.logViewer && config.logViewer.scanDays) {
                    scanDays = config.logViewer.scanDays;
                }

                try {
                    const logCheckResponse = await fetch('config/log_check_config.json');
                    if (logCheckResponse.ok) {
                        const logCheckConfig = await logCheckResponse.json();
                        if (logCheckConfig.logSource) {
                            defaultLogSource = logCheckConfig.logSource;
                            activeLogSource = defaultLogSource;
                            logSource = defaultLogSource;
                        }
                        if (logCheckConfig.supabase) {
                            supabaseConfig = logCheckConfig.supabase;
                            if (logCheckConfig.supabase.scanDays) {
                                scanDays = logCheckConfig.supabase.scanDays;
                            }
                        }
                    }
                } catch (e) {
                }
                
                return logDirectory;
            } catch (error) {
                console.error('Failed to load config:', error);
                logDirectory = './logs';
                scanDays = 90;
                logSource = 'local';
                supabaseConfig = null;
                return './logs';
            }
        }

        // Scan log files directory or Supabase - Smart scan
        async function scanLogFiles(source) {
            const refreshBtn = document.getElementById('refreshBtn');
            const lastRefreshTime = document.getElementById('lastRefreshTime');

            try {
                if (refreshBtn && lastRefreshTime) {
                    refreshBtn.disabled = true;
                    lastRefreshTime.style.display = 'block';
                    lastRefreshTime.textContent = 'Syncing...';
                }

                await loadConfig();
                
                availableLogDates.clear();

                const effectiveSource = source || activeLogSource;

                if (effectiveSource === 'supabase' && supabaseConfig && supabaseConfig.url && supabaseConfig.uploadLogTable) {
                    if (lastRefreshTime) {
                        lastRefreshTime.textContent = 'Syncing online logs...';
                    }
                    await scanSupabaseDates();
                } else {
                    if (lastRefreshTime) {
                        lastRefreshTime.textContent = 'Syncing local logs...';
                    }
                    const foundFiles = await fetchLogListFromServer();
                    if (!foundFiles || foundFiles.length === 0) {
                        await scanRecentDates();
                    }
                }
                
                renderCalendar();
                activeLogSource = effectiveSource;
            } finally {
                if (refreshBtn) {
                    refreshBtn.disabled = !currentDate;
                }
                if (lastRefreshTime && !currentDate) {
                    lastRefreshTime.style.display = 'none';
                }
            }
        }

        async function scanSupabaseDates() {
            try {
                const today = new Date();
                const start = new Date();
                start.setDate(today.getDate() - (scanDays - 1));

                const baseUrl = supabaseConfig.url.replace(/\/+$/, '');
                const table = supabaseConfig.uploadLogTable;

                const dateCounts = {};
                let totalRows = 0;
                let probedDays = 0;

                const probeDate = async (date) => {
                    const from = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0);
                    const to = new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1, 0, 0, 0);

                    const fromIso = from.toISOString();
                    const toIso = to.toISOString();

                    const queryUrl = `${baseUrl}/rest/v1/${encodeURIComponent(table)}?select=timestamp&timestamp=gte.${encodeURIComponent(fromIso)}&timestamp=lt.${encodeURIComponent(toIso)}&limit=1`;

                    const response = await fetch(queryUrl, {
                        headers: {
                            apikey: supabaseConfig.anonKey,
                            Authorization: `Bearer ${supabaseConfig.anonKey}`
                        }
                    });

                    if (!response.ok) {
                        console.error('Failed to load Supabase dates for', fromIso, 'â†’', toIso, await response.text());
                        return;
                    }

                    const rows = await response.json();
                    probedDays += 1;

                    if (!rows || rows.length === 0) {
                        return;
                    }

                    totalRows += rows.length;

                    const ts = rows[0].timestamp;
                    if (!ts) {
                        return;
                    }

                    let dateStr = null;

                    if (typeof ts === 'string') {
                        // Prefer parsing the date portion directly from the Supabase timestamptz string
                        // to avoid browser timezone shifts changing the calendar day.
                        const parts = ts.split('T')[0] || ts.split(' ')[0];
                        if (parts && /^\d{4}-\d{2}-\d{2}$/.test(parts)) {
                            const [year, month, day] = parts.split('-');
                            dateStr = `${year}${month}${day}`;
                        }
                    }

                    if (!dateStr) {
                        // Fallback to Date parsing if the raw string format is unexpected
                        const d = new Date(ts);
                        if (!isNaN(d.getTime())) {
                            dateStr = formatDateToYYYYMMDD(d);
                        }
                    }

                    if (dateStr) {
                        availableLogDates.add(dateStr);
                        dateCounts[dateStr] = (dateCounts[dateStr] || 0) + rows.length;
                    }
                };

                for (let d = new Date(start); d <= today; d.setDate(d.getDate() + 1)) {
                    await probeDate(d);
                }
            } catch (error) {
                console.error('Error scanning Supabase dates:', error);
            }
        }
        
        // Fetch list of available log files from server API
        async function fetchLogListFromServer() {
            try {
                const response = await fetch('/api/logs/list', { 
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const dateArray = await response.json();
                    
                    // Add all dates from server response
                    dateArray.forEach(dateStr => {
                        availableLogDates.add(dateStr);
                    });
                    
                    return dateArray;
                }
            } catch (error) {
            }
            return null;
        }
        
        // Scan recent dates (fallback method - may cause 404s in console)
        async function scanRecentDates() {
            console.warn('[LOG VIEWER] Using fallback scanning method - may see 404 errors in console');
            const today = new Date();
            const promises = [];
            
            // Only scan last 90 days
            for (let i = 0; i < scanDays; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = formatDateToYYYYMMDD(date);
                
                promises.push(checkLogExistsQuietly(dateStr));
            }
            
            await Promise.all(promises);
            return Array.from(availableLogDates);
        }
        
        // Quiet version that suppresses 404 errors in console (still may log fetch errors)
        async function checkLogExistsQuietly(dateStr) {
            const filename = `${dateStr}_processing_agent.csv`;
            const filepath = `${logDirectory}/${filename}`;
            
            try {
                const response = await fetch(filepath, { cache: 'no-cache' });
                
                if (response.ok) {
                    const text = await response.text();
                    const lines = text.trim().split('\n');
                    
                    // Filter out logs that only contain "Rolled log file" message
                    if (lines.length > 1) {
                        let hasRealLogs = false;
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line && !line.includes('Rolled log file to')) {
                                hasRealLogs = true;
                                break;
                            }
                        }
                        
                        if (hasRealLogs) {
                            availableLogDates.add(dateStr);
                        }
                    }
                }
            } catch (error) {
                // Silently ignore all errors
                // Still try File System Access API if available
                if (logsDirectoryHandle) {
                    try {
                        const text = await readFileFromHandle(filename);
                        if (text) {
                            const lines = text.trim().split('\n');
                            if (lines.length > 1) {
                                let hasRealLogs = false;
                                for (let i = 1; i < lines.length; i++) {
                                    const line = lines[i].trim();
                                    if (line && !line.includes('Rolled log file to')) {
                                        hasRealLogs = true;
                                        break;
                                    }
                                }
                                
                                if (hasRealLogs) {
                                    availableLogDates.add(dateStr);
                                }
                            }
                        }
                    } catch (fsError) {
                        // Silently ignore
                    }
                }
            }
        }
        
        // Check if log file exists and has actual data (not just headers or "Rolled" messages)
        async function checkLogExists(dateStr) {
            const filename = `${dateStr}_processing_agent.csv`;
            const filepath = `${logDirectory}/${filename}`;
            
            // Try fetch first (works with proxy server)
            try {
                const response = await fetch(filepath);
                if (response.ok) {
                    const text = await response.text();
                    const lines = text.trim().split('\n');
                    
                    // Only consider it a valid log if it has more than just the header row
                    // AND has real log entries (not just "Rolled log file" message)
                    if (lines.length > 1) {
                        let hasRealLogs = false;
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            // Ignore empty lines and "Rolled log file" messages
                            if (line && !line.includes('Rolled log file to')) {
                                hasRealLogs = true;
                                break;
                            }
                        }
                        
                        if (hasRealLogs) {
                            availableLogDates.add(dateStr);
                        }
                    }
                    return; // Success via fetch, no need to try File System Access API
                }
            } catch (error) {
                // Fetch failed, try File System Access API if available
            }
            
            // Fallback to File System Access API (for GitHub Pages)
            if (logsDirectoryHandle) {
                try {
                    const text = await readFileFromHandle(filename);
                    if (text) {
                        const lines = text.trim().split('\n');
                        if (lines.length > 1) {
                            let hasRealLogs = false;
                            for (let i = 1; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (line && !line.includes('Rolled log file to')) {
                                    hasRealLogs = true;
                                    break;
                                }
                            }
                            
                            if (hasRealLogs) {
                                availableLogDates.add(dateStr);
                            }
                        }
                    }
                } catch (error) {
                    // File doesn't exist or can't be read, ignore
                }
            }
        }
        
        // Format date to YYYYMMDD
        function formatDateToYYYYMMDD(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        // Parse YYYYMMDD to Date
        function parseYYYYMMDD(dateStr) {
            const year = parseInt(dateStr.substring(0, 4));
            const month = parseInt(dateStr.substring(4, 6)) - 1;
            const day = parseInt(dateStr.substring(6, 8));
            return new Date(year, month, day);
        }
        
        // Change month
        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }
        
        // Load today's log
        function loadToday() {
            const today = formatDateToYYYYMMDD(new Date());
            if (availableLogDates.has(today)) {
                loadLogFile(today);
            } else {
                alert('No log file found for today.');
            }
        }
        
        // Render calendar
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            const title = document.getElementById('calendarTitle');
            
            // Update title
            const options = { month: 'long', year: 'numeric' };
            title.textContent = currentMonth.toLocaleDateString(undefined, options);
            
            // Get first day of month and number of days
            const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const lastDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Clear calendar (no headers in grid now)
            calendar.innerHTML = '';
            
            // Add empty cells before first day
            for (let i = 0; i < firstDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                calendar.appendChild(emptyCell);
            }
            
            // Add days
            const today = new Date();
            const todayStr = formatDateToYYYYMMDD(today);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
                const dateStr = formatDateToYYYYMMDD(date);
                const dayOfWeek = date.getDay();
                
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                
                // Add weekend class
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dayCell.classList.add('weekend');
                }
                
                // Check if this date has a log
                if (availableLogDates.has(dateStr)) {
                    dayCell.classList.add('has-log');
                    dayCell.onclick = () => loadLogFile(dateStr);
                    dayCell.title = `Log available for ${date.toLocaleDateString()}`;
                } else {
                    dayCell.classList.add('no-log');
                    dayCell.title = `No log for ${date.toLocaleDateString()}`;
                }
                
                // Highlight today
                if (dateStr === todayStr) {
                    dayCell.classList.add('today');
                }
                
                // Highlight selected date
                if (dateStr === currentDate) {
                    dayCell.classList.add('selected');
                }
                
                calendar.appendChild(dayCell);
            }
        }
        
        // Refresh current log / Resync Online
        async function refreshCurrentLog() {
            if (!currentDate) {
                alert('No log file is currently loaded. Please select a date first.');
                return;
            }
            
            const refreshBtn = document.getElementById('refreshBtn');
            const svg = refreshBtn.querySelector('svg');
            
            // Add spinning animation
            svg.classList.add('spinning');
            refreshBtn.disabled = true;
            
            try {
                const useSupabase = supabaseConfig && supabaseConfig.url && supabaseConfig.uploadLogTable;
                if (useSupabase) {
                    activeLogSource = 'supabase';
                    supabaseDayCache.delete(currentDate);
                    await loadSupabaseLog(currentDate, { forceReload: true });
                } else {
                    await loadLogFile(currentDate);
                }
                
                // Update last refresh timestamp
                const lastRefreshTime = document.getElementById('lastRefreshTime');
                const now = new Date();
                const timeStr = now.toLocaleString(undefined, {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                lastRefreshTime.textContent = `Last: ${timeStr}`;
                lastRefreshTime.style.display = 'block';
            } finally {
                svg.classList.remove('spinning');
                refreshBtn.disabled = false;
            }
        }

        // Load log file for a specific date, using the current active source
        async function loadLogFile(dateStr) {
            currentDate = dateStr;
            document.getElementById('refreshBtn').disabled = false;
            renderCalendar();

            if (activeLogSource === 'supabase' && supabaseConfig && supabaseConfig.url && supabaseConfig.uploadLogTable) {
                await loadSupabaseLog(dateStr);
                return;
            }

            const filename = `${dateStr}_processing_agent.csv`;
            
            try {
                let text = null;
                const filepath = `${logDirectory}/${filename}`;
                
                try {
                    const response = await fetch(filepath);
                    if (response.ok) {
                        text = await response.text();
                    }
                } catch (fetchError) {
                }
                
                if (!text && logsDirectoryHandle) {
                    text = await readFileFromHandle(filename);
                }
                
                if (!text) {
                    throw new Error('File not found via fetch or File System Access API');
                }
                
                parseLogs(text);
                applyFilters();
            } catch (error) {
                console.error('Error loading log file:', error);
                
                const isGitHubPages = window.location.hostname.includes('github.io');
                const isFileProtocol = window.location.protocol === 'file:';
                
                let errorMessage = `No log file found for this date (${filename})`;
                
                if (!logsDirectoryHandle && (isGitHubPages || (!window.location.hostname.includes('localhost') && !window.location.hostname.includes('127.0.0.1') && !isFileProtocol))) {
                    errorMessage = `
                        <div class="text-center">
                            <div class="text-yellow-500 font-semibold mb-2">ðŸ“ Grant Folder Access</div>
                            <div class="text-sm text-[color:var(--muted-foreground)] mb-3">
                                Click "Scan Logs" and select your logs folder to grant access.
                            </div>
                            <div class="text-xs text-left bg-gray-100 dark:bg-gray-800 p-3 rounded-lg">
                                <div class="text-[color:var(--foreground)] font-semibold mb-1">Folder location:</div>
                                <div class="text-[color:var(--muted-foreground)] font-mono text-[10px] break-all">
                                    OneDrive/.../4Set-Server/logs/
                                </div>
                                <div class="text-[color:var(--foreground)] font-semibold mt-2 mb-1">Alternative (local server):</div>
                                <div class="text-[color:var(--primary)] font-mono text-[10px]">python proxy_server.py --port 5000</div>
                                <div class="text-[color:var(--primary)] font-mono text-[10px] mt-1">http://localhost:5000/log.html</div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('logTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" class="px-3 py-6">
                            ${errorMessage}
                        </td>
                    </tr>
                `;
                allLogs = [];
                filteredLogs = [];
                updateStats();
            }
        }

        async function loadSupabaseLog(dateStr, options = {}) {
            if (!supabaseConfig || !supabaseConfig.url || !supabaseConfig.uploadLogTable) {
                return;
            }

            try {
                const forceReload = options.forceReload === true;

                if (!forceReload && supabaseDayCache.has(dateStr)) {
                    allLogs = supabaseDayCache.get(dateStr);
                    // Build file-to-school mapping and update dropdown from cached logs
                    buildFileToSchoolMap();
                    updateSchoolFilterOptions();
                    filteredLogs = [...allLogs];
                    applyFilters();
                    return;
                }
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6));
                const day = parseInt(dateStr.substring(6, 8));

                const from = new Date(year, month - 1, day, 0, 0, 0);
                const to = new Date(year, month - 1, day + 1, 0, 0, 0);

                const fromIso = from.toISOString();
                const toIso = to.toISOString();

                const baseUrl = supabaseConfig.url.replace(/\/+$/, '');
                const table = supabaseConfig.uploadLogTable;
                const pageSize = 1000;
                let offset = 0;
                let allRows = [];
                let page = 0;

                while (true) {
                    const queryUrl = `${baseUrl}/rest/v1/${encodeURIComponent(table)}?select=timestamp,level,file,message&timestamp=gte.${encodeURIComponent(fromIso)}&timestamp=lt.${encodeURIComponent(toIso)}&order=timestamp.asc&limit=${pageSize}&offset=${offset}`;

                    const response = await fetch(queryUrl, {
                        headers: {
                            apikey: supabaseConfig.anonKey,
                            Authorization: `Bearer ${supabaseConfig.anonKey}`
                        }
                    });

                    if (!response.ok) {
                        console.error('Failed to load Supabase logs page', page, 'for', fromIso, 'â†’', toIso, await response.text());
                        throw new Error('Supabase request failed');
                    }

                    const rows = await response.json();
                    page += 1;

                    if (!rows || rows.length === 0) {
                        break;
                    }

                    allRows = allRows.concat(rows);

                    if (rows.length < pageSize) {
                        break;
                    }

                    offset += pageSize;
                }

                allLogs = allRows.map(row => {
                    const ts = row.timestamp;
                    const dt = new Date(ts);
                    return {
                        timestamp: dt,
                        timestampRaw: ts,
                        level: row.level || '',
                        file: row.file || '',
                        message: row.message || ''
                    };
                });

                supabaseDayCache.set(dateStr, allLogs);

                // Build file-to-school mapping and update dropdown
                buildFileToSchoolMap();
                updateSchoolFilterOptions();

                filteredLogs = [...allLogs];
                applyFilters();
            } catch (error) {
                console.error('Error loading Supabase log:', error);

                document.getElementById('logTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" class="px-3 py-6">
                            Failed to load logs from Supabase for this date.
                        </td>
                    </tr>
                `;
                allLogs = [];
                filteredLogs = [];
                updateStats();
            }
        }

        // Parse CSV log file - REMOVE QUOTES
        function parseLogs(csvText) {
            const lines = csvText.trim().split('\n');
            allLogs = [];
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                
                // Parse CSV (handle quoted fields)
                const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                if (!matches || matches.length < 4) continue;
                
                const timestamp = matches[0].replace(/^"|"$/g, '').trim();
                const level = matches[1].replace(/^"|"$/g, '').trim();
                const file = matches[2].replace(/^"|"$/g, '').trim();
                const message = matches.slice(3).join(',').replace(/^"|"$/g, '').trim();
                
                allLogs.push({
                    timestamp: new Date(timestamp),
                    timestampRaw: timestamp,
                    level,
                    file,
                    message
                });
            }
            
            // Build file-to-school mapping and update dropdown
            buildFileToSchoolMap();
            updateSchoolFilterOptions();
            
            filteredLogs = [...allLogs];
        }

        // Apply filters
        function applyFilters() {
            const fileFilter = document.getElementById('fileFilter').value.toLowerCase();
            const levelFilter = document.getElementById('levelFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;
            
            filteredLogs = allLogs.filter(log => {
                // File/session key filter
                if (fileFilter && !log.file.toLowerCase().includes(fileFilter)) {
                    return false;
                }
                
                // Level filter
                if (levelFilter && log.level !== levelFilter) {
                    return false;
                }
                
                // School ID filter - only filter out logs whose files have a DIFFERENT school
                // Include logs without files or files without school mapping
                if (schoolFilter && log.file) {
                    const fileSchool = fileToSchoolMap.get(log.file);
                    // Only exclude if the file has a known school that doesn't match
                    if (fileSchool && fileSchool !== schoolFilter) {
                        return false;
                    }
                }
                
                // File type filter
                if (currentFileTypeFilter !== 'all' && log.file) {
                    const fileType = getFileType(log.file);
                    if (currentFileTypeFilter === 'pdf' && fileType !== 'pdf') {
                        return false;
                    }
                    if (currentFileTypeFilter === 'edat3' && fileType !== 'edat3') {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderLogs();
            updateStats();
            calculateProcessingTimes();
        }

        // Render logs - compact view
        function renderLogs() {
            const tbody = document.getElementById('logTableBody');
            
            if (filteredLogs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-2 py-4 text-center text-xs" style="color: var(--muted-foreground);">
                            No log entries found matching filters
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredLogs.map(log => {
                // Compact time format: HH:MM:SS only
                const timeStr = log.timestamp.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const displayFile = log.file ? getDisplayFilename(log.file) : '';
                
                return `
                    <tr class="log-row">
                        <td class="px-2 py-1 text-[0.65rem] text-[color:var(--muted-foreground)] whitespace-nowrap" title="${escapeHtml(log.timestampRaw)}">${timeStr}</td>
                        <td class="px-2 py-1"><span class="log-level-pill log-level-${log.level}">${log.level}</span></td>
                        <td class="px-2 py-1 text-[0.65rem] font-mono text-[color:var(--foreground)] truncate max-w-[150px]" title="${escapeHtml(log.file || '')}">${displayFile || '<em class="opacity-50">â€”</em>'}</td>
                        <td class="px-2 py-1 text-[0.65rem] text-[color:var(--foreground)]">${escapeHtml(log.message)}</td>
                    </tr>
                `;
            }).join('');
        }

        // Update statistics
        function updateStats() {
            document.getElementById('statTotal').textContent = filteredLogs.length;
            
            // Count unique files by type (exclude empty file field)
            const files = new Set(filteredLogs.filter(log => log.file).map(log => log.file));
            
            // Count by file type
            let pdfCount = 0;
            let edat3Count = 0;
            files.forEach(filename => {
                const type = getFileType(filename);
                if (type === 'pdf') pdfCount++;
                else if (type === 'edat3') edat3Count++;
            });
            
            document.getElementById('statPdfCount').textContent = pdfCount;
            document.getElementById('statEdat3Count').textContent = edat3Count;
            
            // Count rejections
            const rejects = filteredLogs.filter(log => log.level === 'REJECT').length;
            document.getElementById('statRejects').textContent = rejects;
            
            // Re-initialize lucide icons for dynamically added content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Calculate processing times
        function calculateProcessingTimes() {
            const fileTimings = {};
            const fileFilter = document.getElementById('fileFilter').value.toLowerCase();
            const schoolFilter = document.getElementById('schoolFilter').value;
            
            // Group logs by file
            allLogs.forEach(log => {
                if (!log.file) return;
                
                if (!fileTimings[log.file]) {
                    fileTimings[log.file] = {
                        filename: log.file,
                        startTime: null,
                        endTime: null,
                        latestTime: null,
                        status: 'processing',
                        logs: []
                    };
                }
                
                const timing = fileTimings[log.file];
                timing.logs.push(log);
                
                // Track start time (first log entry)
                if (!timing.startTime) {
                    timing.startTime = log.timestamp;
                }
                
                // Always track latest log time for this file
                if (!timing.latestTime || log.timestamp > timing.latestTime) {
                    timing.latestTime = log.timestamp;
                }
                
                // Track end time and status - CHECK FOR SUCCESS MESSAGE
                // PDF success: "Jotform upload completed successfully"
                // E-Prime success: "E-Prime upload completed:" 
                if (log.message.includes('Jotform upload completed successfully') || 
                    log.message.includes('E-Prime upload completed:')) {
                    timing.endTime = log.timestamp;
                    timing.status = 'success';
                } else if (log.level === 'REJECT' || log.level === 'ERROR') {
                    timing.endTime = log.timestamp;
                    timing.status = 'failed';
                }
            });
            
            // Calculate durations and apply file filter + school filter
            const timings = Object.values(fileTimings)
                .filter(timing => {
                    // Apply file filter to timings table
                    if (fileFilter && !timing.filename.toLowerCase().includes(fileFilter)) {
                        return false;
                    }
                    // Apply school filter to timings table - only exclude if file has a DIFFERENT school
                    if (schoolFilter) {
                        const fileSchool = fileToSchoolMap.get(timing.filename);
                        if (fileSchool && fileSchool !== schoolFilter) {
                            return false;
                        }
                    }
                    return true;
                })
                .map(timing => {
                    if (timing.startTime && timing.endTime) {
                        timing.duration = (timing.endTime - timing.startTime) / 1000; // seconds
                    }
                    return timing;
                })
                .filter(t => t.duration !== undefined);
            
            // Apply file type filter to timings
            const filteredTimings = timings.filter(timing => {
                if (currentFileTypeFilter === 'all') return true;
                const type = getFileType(timing.filename);
                return type === currentFileTypeFilter;
            });
            
            // Sort by latest update time (newest first)
            filteredTimings.sort((a, b) => (b.latestTime || 0) - (a.latestTime || 0));
            
            // Calculate average (only from filtered results)
            if (filteredTimings.length > 0) {
                const avg = filteredTimings.reduce((sum, t) => sum + t.duration, 0) / filteredTimings.length;
                document.getElementById('statAvgTime').textContent = avg.toFixed(2) + 's';
            } else {
                document.getElementById('statAvgTime').textContent = '0s';
            }
            
            // Render timings table
            renderTimings(filteredTimings);
        }

        // Helper: Get display name for file (full name without extension)
        function getDisplayFilename(filename) {
            if (!filename) return '';
            // Remove extension
            return filename.replace(/\.(pdf|edat3)$/i, '');
        }

        // Render processing times table
        function renderTimings(timings) {
            const container = document.getElementById('timingsContainer');
            const table = document.getElementById('timingsTable');
            
            // Always show container if we have any logs loaded
            if (allLogs.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Show empty state if no files match the filter
            if (timings.length === 0) {
                const filterName = currentFileTypeFilter === 'pdf' ? 'PDF' : 
                                   currentFileTypeFilter === 'edat3' ? 'E-Prime' : '';
                table.innerHTML = `
                    <div class="text-center py-3 text-xs text-gray-500">
                        No ${filterName} files found in this log
                    </div>
                `;
                return;
            }
            
            container.style.display = 'block';
            
            table.innerHTML = `
                <div class="overflow-x-auto" style="max-height: 200px; overflow-y: auto;">
                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                        <thead class="sticky top-0 bg-white">
                            <tr>
                                <th class="px-1.5 py-1 text-left text-[0.6rem] font-medium text-gray-500 uppercase w-5"></th>
                                <th class="px-1.5 py-1 text-left text-[0.6rem] font-medium text-gray-500 uppercase">File</th>
                                <th class="px-1.5 py-1 text-left text-[0.6rem] font-medium text-gray-500 uppercase w-12">School</th>
                                <th class="px-1.5 py-1 text-left text-[0.6rem] font-medium text-gray-500 uppercase w-16">Latest Update</th>
                                <th class="px-1.5 py-1 text-left text-[0.6rem] font-medium text-gray-500 uppercase w-12">Time</th>
                                <th class="px-1.5 py-1 text-center text-[0.6rem] font-medium text-gray-500 uppercase w-6">OK</th>
                                <th class="px-1.5 py-1 text-[0.6rem] font-medium text-gray-500 uppercase w-16"></th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${timings.map(timing => {
                                const displayName = getDisplayFilename(timing.filename);
                                const typeBadge = getFileTypeBadge(timing.filename);
                                const schoolId = fileToSchoolMap.get(timing.filename) || 'â€”';
                                const latestTimeStr = timing.latestTime ? timing.latestTime.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '-';
                                
                                return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-1.5 py-0.5">${typeBadge}</td>
                                    <td class="px-1.5 py-0.5 font-mono text-gray-900 truncate max-w-[180px]" title="${escapeHtml(timing.filename)}">${escapeHtml(displayName)}</td>
                                    <td class="px-1.5 py-0.5 text-[0.6rem] font-semibold" style="color: var(--primary);">${schoolId}</td>
                                    <td class="px-1.5 py-0.5 text-gray-500 text-[0.6rem] font-mono">${latestTimeStr}</td>
                                    <td class="px-1.5 py-0.5">
                                        <span class="duration-badge text-white px-1 py-0 rounded text-[0.6rem]">${timing.duration.toFixed(1)}s</span>
                                    </td>
                                    <td class="px-1.5 py-0.5 text-center">
                                        ${timing.status === 'success' 
                                            ? '<span class="text-green-600">âœ“</span>'
                                            : '<span class="text-red-600">âœ—</span>'
                                        }
                                    </td>
                                    <td class="px-1.5 py-0.5">
                                        <button data-filename="${escapeHtml(timing.filename)}" class="view-logs-btn bg-blue-500 hover:bg-blue-600 text-white text-[0.6rem] font-medium px-2 py-0.5 rounded shadow-sm transition-colors" title="Show all logs for this file">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-0.5"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>Logs
                                        </button>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Re-initialize lucide icons for the file type badges
            // Use setTimeout to ensure DOM is updated before icon replacement
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 0);
            
            // Attach event listeners to all View Logs buttons
            table.querySelectorAll('.view-logs-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    filterByFile(btn.dataset.filename);
                });
            });
        }

        // Filter by specific file
        function filterByFile(filename) {
            document.getElementById('fileFilter').value = filename;
            applyFilters();
            // Scroll to logs table
            document.querySelector('#logTableBody').scrollIntoView({ behavior: 'smooth' });
        }

        // Quick filter functions
        function showOnlyErrors() {
            document.getElementById('levelFilter').value = '';
            const fileFilter = document.getElementById('fileFilter').value.toLowerCase();
            const schoolFilter = document.getElementById('schoolFilter').value;
            
            filteredLogs = allLogs.filter(log => {
                const isError = ['ERROR', 'REJECT', 'WARN', 'DATA_OVERWRITE_DIFF'].includes(log.level);
                const matchesFile = !fileFilter || log.file.toLowerCase().includes(fileFilter);
                
                // School ID filter - only exclude if file has a DIFFERENT school
                if (schoolFilter && log.file) {
                    const fileSchool = fileToSchoolMap.get(log.file);
                    if (fileSchool && fileSchool !== schoolFilter) return false;
                }
                
                // Also apply file type filter
                if (currentFileTypeFilter !== 'all' && log.file) {
                    const fileType = getFileType(log.file);
                    if (currentFileTypeFilter !== fileType) return false;
                }
                
                return isError && matchesFile;
            });
            
            renderLogs();
            updateStats();
            calculateProcessingTimes();
        }

        function showOnlySuccess() {
            document.getElementById('levelFilter').value = '';
            const fileFilter = document.getElementById('fileFilter').value.toLowerCase();
            const schoolFilter = document.getElementById('schoolFilter').value;
            
            filteredLogs = allLogs.filter(log => {
                const isSuccess = log.message.includes('Jotform upload completed successfully');
                const matchesFile = !fileFilter || log.file.toLowerCase().includes(fileFilter);
                
                // School ID filter - only exclude if file has a DIFFERENT school
                if (schoolFilter && log.file) {
                    const fileSchool = fileToSchoolMap.get(log.file);
                    if (fileSchool && fileSchool !== schoolFilter) return false;
                }
                
                // Also apply file type filter
                if (currentFileTypeFilter !== 'all' && log.file) {
                    const fileType = getFileType(log.file);
                    if (currentFileTypeFilter !== fileType) return false;
                }
                
                return isSuccess && matchesFile;
            });
            
            renderLogs();
            updateStats();
            calculateProcessingTimes();
        }

        function clearFilters() {
            document.getElementById('fileFilter').value = '';
            document.getElementById('levelFilter').value = '';
            document.getElementById('schoolFilter').value = '';
            setFileTypeFilter('all'); // Also reset file type filter
        }

        // Utility functions
        function getRelativeTime(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.getElementById('fileFilter').addEventListener('input', applyFilters);
        document.getElementById('levelFilter').addEventListener('change', applyFilters);
        document.getElementById('schoolFilter').addEventListener('change', applyFilters);

        // Refresh on F5
        window.addEventListener('beforeunload', function() {
            // Trigger scan on page reload
            sessionStorage.setItem('shouldScanLogs', 'true');
        });

        // Initialize
        async function init() {
            // Initialize lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Create background circles
            const bgCircles = document.getElementById('background-circles');
            if (bgCircles) {
                for (let i = 0; i < 15; i++) {
                    const circle = document.createElement('div');
                    circle.className = 'background-circle';
                    bgCircles.appendChild(circle);
                }
            }
            
            await loadConfig();
            await scanLogFiles();
            
            // Try to load today's log by default
            const today = formatDateToYYYYMMDD(new Date());
            if (availableLogDates.has(today)) {
                loadLogFile(today);
            }
        }
        
        init();
    </script>
</body>
</html>
